# TASK-009: Voice 분석 (Parselmouth) Plan

## 1. Scope 정의

### 1.1 목표
- **Parselmouth (Praat)** 라이브러리를 활용하여 온디맨드(On-demand) 방식의 음성 분석 기능을 구현한다.
- 오디오 파일에서 주요 음향학적(Acoustic) 지표(Pitch, Intensity, Jitter, Shimmer, HNR)를 추출하여 반환한다.
- 기존의 Mock 기반 동작을 실제 분석 로직으로 대체하고, Playground 환경에서 이를 검증한다.

### 1.2 포함 대상
- **음성 분석 로직 구현**
  - `praat-parselmouth` 라이브러리를 사용한 분석기 구현
  - `Sound` 객체 기반의 음성 지표 추출 로직
- **데이터 구조 확장**
  - 분석 결과(Pitch, Intensity 등)를 담을 수 있는 데이터 구조 정의
- **API 연동**
  - Playground 환경에서 파일 업로드를 통해 분석을 요청할 수 있는 엔드포인트 제공
- **라이브러리 의존성 추가**
  - `praat-parselmouth` (안정적인 버전)

### 1.3 제외 대상
- **실시간 스트리밍 분석**: 파일 업로드 방식(Playground)만 다루며, 실시간(WebRTC/Stream) 처리는 제외한다.
- **복잡한 감정/발화 내용 분석**: 텍스트(STT)나 감정(Emotion) 분석과는 별개로 순수 **음향학적 특성**만 추출한다.
- **대용량 파일 처리**: Playground 검증 용도로, 짧은 길이(1~2분 이내)의 오디오 분석을 전제로 한다.

---

## 2. 입출력 계약 (Contract) 초안

### 2.1 입력 (Request)
- **전송 방식**: HTTP Multipart Form Data
- **파라미터**: 오디오 파일 (Binary)
  - 권장 포맷: WAV (Parselmouth 호환성 최적)
  - 허용 포맷: MP3/WebM 등 (라이브러리 지원 범위 내, 실패 시 예외 처리)

### 2.2 출력 (Response)
- **형식**: JSON 구조체
- **주요 필드 구성**:

| 필드명 | 타입 | 설명 | 비고 |
|---|---|---|---|
| `pitch_mean` | `float` | 평균 음높이 (Hz) | 무음 구간 제외 |
| `pitch_min` | `float` | 최소 음높이 (Hz) | (추가 예정) |
| `pitch_max` | `float` | 최대 음높이 (Hz) | (추가 예정) |
| `intensity_mean` | `float` | 평균 음량 (dB) | (신규 추가) |
| `intensity_min` | `float` | 최소 음량 (dB) | (신규 추가) |
| `intensity_max` | `float` | 최대 음량 (dB) | (신규 추가) |
| `jitter` | `float` | 음높이 변동률 (local) | 성대 진동 안정성 |
| `shimmer` | `float` | 음량 변동률 (local) | 성대 접촉 안정성 |
| `hnr` | `float` | 소음 대 배음 비율 (dB) | 음질/청명도 |

> **Note**: 분석 불가(예: 무음, 너무 짧은 파일) 시 해당 필드는 `null` 또는 `0.0`으로 반환될 수 있음.

---

## 3. 품질 / 성능 / 안정성 기준

### 3.1 성공 기준
- **재현성**: 동일한 오디오 파일 입력 시, 허용 오차 범위 내에서 동일한 분석 결과가 반환되어야 한다.
- **예외 처리**:
  - **무음 파일**: 분석이 불가능한 경우 시스템 에러(500)가 아닌, 명시적인 빈 결과(null/0.0)를 반환해야 한다.
  - **손상된 파일**: 라이브러리 예외를 포착하여 적절한 클라이언트 에러(400/422)로 응답해야 한다.
- **응답 속도**: 일반적인 인터뷰 답변 길이(1분 내외) 기준, 수 초 이내에 분석이 완료되어야 한다 (CPU 연산).

### 3.2 실패 케이스 처리
- **포맷 미지원**: 분석 라이브러리가 해석할 수 없는 포맷인 경우 명확한 에러 메시지를 반환한다.
- **분석 조건 미달**: 너무 짧은 오디오 등으로 특정 지표(Jitter 등) 산출이 불가능한 경우, 해당 지표만 `null` 처리하고 나머지는 반환한다.

---

## 4. 검증 (Validation) 시나리오

### 4.1 로컬 검증 시나리오
1. **정상 파일 분석**
   - 표준적인 음성 파일(WAV)을 사용하여 분석 요청을 수행한다.
   - 응답 코드가 성공(200)이며, 주요 지표(Pitch Mean 등)가 유효한 양수 값인지 확인한다.
2. **무음(Silence) 처리**
   - 1초 이상의 완전한 무음 파일을 생성하여 분석 요청을 수행한다.
   - 분석 과정에서 크래시(Crash)가 발생하지 않고, 결과값이 `null` 또는 `0`으로 적절히 처리되는지 확인한다.
3. **비정상 파일 처리**
   - 오디오 파일이 아닌 파일(텍스트 등)을 오디오로 가장하여 전송한다.
   - 시스템 내부 오류(500)가 아닌 요청 오류(400/422)로 처리되는지 확인한다.

### 4.2 로그 관측 포인트
- **요청 정보**: 파일의 메타데이터(파일명, 크기 등)가 기록되어야 한다.
- **분석 상태**: 분석 객체 생성 성공 여부 및 소요 시간이 기록되어야 한다.
- **결과 요약**: 산출된 주요 지표의 요약 정보가 로그에 남아야 한다.
- **예외 상황**: 파일 로드 실패나 분석 실패 시 상세한 원인(StackTrace 등)이 로그 파일에 기록되어야 한다.

---

## 5. 의존성 및 운영 고려사항

### 5.1 라이브러리 의존성
- **Core Library**: `praat-parselmouth` (필수)
- **Support**: `numpy` (데이터 처리를 위한 의존성)

### 5.2 운영 리스크 및 추상화
- **시스템 의존성**: 분석 라이브러리가 특정 OS의 시스템 오디오 코덱이나 바이너리에 의존할 수 있으므로, 배포 환경(Docker/Linux 등)에서의 호환성을 고려해야 한다.
- **추상화 원칙**: 향후 다른 분석 엔진(GPU 기반 모델 등)으로 교체될 가능성을 염두에 두고, 인터페이스 기반으로 구현하여 엔진 교체가 용이하도록 설계한다.

---

## 6. 작업 단계 개요

승인 후 다음 순서로 작업을 진행한다.

1.  **의존성 추가**: 프로젝트 환경에 필요한 분석 라이브러리를 추가한다.
2.  **데이터 구조 정의**: 음성 분석 결과(Pitch, Intensity 등)를 담을 DTO 구조를 확장한다.
3.  **분석 모듈 구현**: 라이브러리를 활용하여 오디오 파일을 로드하고 지표를 추출하는 핵심 로직을 작성한다.
    - 임시 파일 처리 및 자원 해제 로직 포함.
4.  **API 엔드포인트 구현**: Playground에서 해당 기능을 호출할 수 있도록 라우팅 및 핸들러를 추가한다.
5.  **검증 수행**: 정의된 검증 시나리오에 따라 테스트 스크립트를 작성하고 실행하여 기능을 확인한다.
6.  **문서화**: 작업 내용과 결과를 개발 로그에 기록한다.

---

## 7. 오픈 이슈 / 결정 필요 사항

### 7.1 오디오 포맷 지원 범위
- **이슈**: 웹 환경(브라우저) 녹음 파일(WebM 등)과 분석 라이브러리의 최적 포맷(WAV) 간 불일치 가능성.
- **제안**: 
  - 1단계(현재)에서는 **WAV 포맷 위주**로 지원하고, 변환 로직 복잡도를 최소화한다.
  - 프론트엔드나 추후 단계에서 변환을 처리하도록 유보한다.

### 7.2 무음 구간 정책
- **이슈**: 무음 구간 포함 여부에 따라 평균값이 왜곡될 수 있음.
- **제안**: 별도의 복잡한 VAD(Voice Activity Detection) 모델 도입 없이, 분석 라이브러리의 내장 기능(Pitch 감지 여부)을 활용하여 "발화 구간(Voiced Frames)" 위주로 통계를 산출한다.

### 7.3 파일 저장 정책
- **제안**: "원본 파일 장기 저장 금지" 원칙에 따라, 분석을 위한 임시 저장 후 즉시 삭제 처리한다.
