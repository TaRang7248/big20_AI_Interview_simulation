# # docker-compose.yml 1
# version: '3.8'

# services:
#   db:
#     # 일반 postgres 이미지가 아닌, pgvector가 포함된 공식 이미지를 사용합니다.
#     image: pgvector/pgvector:pg16
#     container_name: interview_db_container
#     environment:
#       POSTGRES_USER: postgres
#       POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # 보안상 .env 변수로 빼는 것이 좋으나 개발용으로 명시
#       POSTGRES_DB: interview_db
#     ports:
#       - "5432:5432"
#     volumes:
#       - postgres_data:/var/lib/postgresql/data

# volumes:
#   postgres_data:

# =============================================================================
# docker-compose.yml — AI 모의면접 통합 시스템
# =============================================================================
# 아키텍처 (SAD 설계서 준수):
#   Client → NGINX (80/443) → FastAPI (8000) / Next.js (3000)
#                            → Redis (6379) + PostgreSQL (5432)
#
# 실행 방법:
#   1) 인증서 생성: cd CSH/nginx && powershell -File generate-certs.ps1
#   2) 시스템 시작: docker-compose up --build
#   3) 접속:       https://localhost
# =============================================================================

services:

  # ─────────────────────────────────────────────────────────────────────────
  # API Gateway — NGINX (SAD: Gateway Layer)
  # - SSL 종단 (TLS 1.2/1.3)
  # - 로드 밸런싱 (least_conn)
  # - Rate Limiting (API: 20r/s, Auth: 5r/s)
  # - 보안 헤더 (HSTS, X-Frame-Options 등)
  # ─────────────────────────────────────────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: interview_gateway
    ports:
      - "80:80"      # HTTP  → HTTPS 리다이렉트
      - "443:443"    # HTTPS (SSL 종단)
    volumes:
      # NGINX 설정 파일 마운트
      - ./CSH/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL 인증서 마운트 (generate-certs.ps1로 사전 생성 필요)
      - ./CSH/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      fastapi:
        condition: service_healthy
      nextjs:
        condition: service_started
    restart: unless-stopped
    networks:
      - interview_net
    # 헬스 체크 — NGINX 자체 상태 확인
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────
  # Core API + Signaling Server — FastAPI (SAD: Application Layer)
  # ─────────────────────────────────────────────────────────────────────────
  fastapi:
    build:
      context: .
      dockerfile: CSH/Dockerfile
    container_name: interview_fastapi
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/interview_db
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV:-development}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - DID_API_KEY=${DID_API_KEY}
      - HUME_API_KEY=${HUME_API_KEY}
      - HUME_SECRET_KEY=${HUME_SECRET_KEY}
      - HUME_CONFIG_ID=${HUME_CONFIG_ID}
      - LLM_MODEL=${LLM_MODEL:-exaone-deep:2.4b-q8_0}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      # NGINX 뒤에서 동작하므로 직접 TLS 불필요
      - TLS_CERTFILE=
      - TLS_KEYFILE=
    # 외부 노출 포트는 NGINX가 담당하므로 내부 네트워크만 사용
    expose:
      - "8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - interview_net
    volumes:
      - ./uploads:/app/uploads
    # 헬스 체크 — NGINX upstream 모니터링에 활용
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────
  # Frontend — Next.js (SAD: Presentation Layer)
  # ─────────────────────────────────────────────────────────────────────────
  nextjs:
    build:
      context: ./CSH/frontend
      dockerfile: Dockerfile
    container_name: interview_nextjs
    environment:
      - NEXT_PUBLIC_API_URL=http://fastapi:8000
    expose:
      - "3000"
    restart: unless-stopped
    networks:
      - interview_net

  # ─────────────────────────────────────────────────────────────────────────
  # Database — PostgreSQL + pgvector (SAD: Data Layer)
  # ─────────────────────────────────────────────────────────────────────────
  db:
    image: pgvector/pgvector:pg16
    container_name: interview_db_container
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: interview_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - interview_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─────────────────────────────────────────────────────────────────────────
  # Cache / Message Broker — Redis (SAD: Data Layer)
  # ─────────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: interview_redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - interview_net
    volumes:
      - redis_data:/data

  # ─────────────────────────────────────────────────────────────────────────
  # Celery Worker — 비동기 작업 처리 (SAD: Async Tasks Layer)
  # ─────────────────────────────────────────────────────────────────────────
  celery_worker:
    build:
      context: .
      dockerfile: CSH/Dockerfile
    container_name: interview_celery
    command: ["python", "-m", "celery", "-A", "celery_app", "worker", "--pool=solo", "--loglevel=info"]
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/interview_db
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - LLM_MODEL=${LLM_MODEL:-exaone-deep:2.4b-q8_0}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
    depends_on:
      redis:
        condition: service_started
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "celery -A celery_app inspect ping -d celery@$$HOSTNAME >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - interview_net

# ─────────────────────────────────────────────────────────────────────────
# 볼륨 정의
# ─────────────────────────────────────────────────────────────────────────
volumes:
  postgres_data:
  redis_data:

# ─────────────────────────────────────────────────────────────────────────
# 네트워크 정의 — 모든 서비스가 동일 네트워크에서 통신
# ─────────────────────────────────────────────────────────────────────────
networks:
  interview_net:
    driver: bridge
