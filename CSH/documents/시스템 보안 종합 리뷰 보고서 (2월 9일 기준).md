
## 🔒 CSH 시스템 보안 종합 리뷰 보고서

---

### 1. 비밀번호 해싱 (Password Hashing)

| 항목 | 상태 | 상세 |
|------|------|------|
| **알고리즘** | ✅ bcrypt (rounds=12) | security.py `hash_password()` |
| **하위 호환** | ✅ SHA-256 fallback | `verify_password()`에서 기존 SHA-256 해시 자동 검증 |
| **자동 마이그레이션** | ✅ 적용됨 | 로그인 시 SHA-256 → bcrypt 자동 재해싱 (`needs_rehash()`) |
| **적용 범위** | ✅ 전체 5곳 | 회원가입, 로그인, 비밀번호 변경 등 모든 비밀번호 처리 |

> **평가**: 🟢 **양호** — 업계 표준(bcrypt)으로 완전 전환 완료, 하위 호환 및 자동 마이그레이션까지 구현됨

---

### 2. API 인증 (JWT Bearer Token)

| 항목 | 상태 | 상세 |
|------|------|------|
| **알고리즘** | HS256 | python-jose 라이브러리 |
| **만료 시간** | 120분 | `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` 환경변수 설정 |
| **비밀키** | 환경변수 | `JWT_SECRET_KEY` (미설정 시 `uuid4()` 자동 생성) |
| **보호된 엔드포인트** | **16개** | `Depends(get_current_user)` 적용 |

**보호된 API 목록:**
- 사용자 정보 조회/수정, 이력서 업로드/삭제
- 면접 이력 조회, 세션 생성, 채팅, 개입 채팅
- 리포트 생성, 평가, 비동기 평가/배치평가
- 비동기 감정 분석, 비동기 리포트 생성, 면접 완료

**⚠️ 비보호 엔드포인트:**
- 상태 확인 페이지 (`/`, `/health`)
- 정적 HTML 파일 서빙
- 소셜 로그인 콜백 (OAuth2 플로우)
- WebRTC offer, 감정 분석 일부
- Celery 상태 확인

> **평가**: 🟢 **양호** — 핵심 데이터 API 전체에 JWT 인증 적용됨

---

### 3. TLS/HTTPS 지원

| 항목 | 상태 | 상세 |
|------|------|------|
| **구현** | ✅ 준비됨 | security.py `get_ssl_context()` |
| **설정 방식** | 환경변수 | `TLS_CERTFILE`, `TLS_KEYFILE` |
| **자체 서명 인증서** | ✅ | `generate_self_signed_cert()` 유틸 제공 |
| **현재 상태** | ⚠️ HTTP | 개발 환경에서 TLS 비활성화 상태 |

> **평가**: 🟡 **보통** — 코드는 준비되어 있으나 운영 환경 배포 시 인증서 설정 필요

---

### 4. 소셜 로그인 (OAuth2)

| 제공자 | 상태 | 인증 방식 |
|--------|------|-----------|
| **Kakao** | ✅ | OAuth2 Authorization Code Flow |
| **Google** | ✅ | OAuth2 Authorization Code Flow |
| **Naver** | ✅ | OAuth2 Authorization Code Flow |

- 서버 측에서 `access_token` 교환 → 사용자 프로필 조회 → 내부 JWT 발급
- Client ID/Secret은 환경변수로 관리

> **평가**: 🟢 **양호** — 표준 OAuth2 플로우 준수. 단, 소셜 가입 시 `password_hash`가 빈 문자열로 저장되는 점 주의

---

### 5. 외부 서비스 API 키 관리

| 서비스 | 관리 방식 | 환경변수명 |
|--------|-----------|-----------|
| Deepgram (STT) | `os.getenv()` | `DEEPGRAM_API_KEY` |
| Hume AI (TTS) | OAuth2 client_credentials | `HUME_API_KEY`, `HUME_SECRET_KEY` |
| Anthropic (Claude) | `os.getenv()` | `ANTHROPIC_API_KEY` |
| D-ID (Avatar) | `os.getenv()` | `DID_API_KEY` |
| Kakao/Google/Naver | `os.getenv()` | 각 `*_CLIENT_ID`, `*_CLIENT_SECRET` |

- 모든 파일에서 `load_dotenv()` 호출하여 .env 파일로 통합 관리
- 하드코딩된 API 키 **없음** ✅

> **평가**: 🟢 **양호** — 전체적으로 환경변수 기반 비밀 관리 일관 적용

---

### 6. 세션 관리 (클라이언트 측)

| 항목 | 값 | 위치 |
|------|-----|------|
| **저장소** | `sessionStorage` | 브라우저 탭 종료 시 자동 소멸 |
| **세션 타임아웃** | 60분 | integrated_interview_server.py |
| **유휴 타임아웃** | 30분 | integrated_interview_server.py |
| **저장 항목** | `interview_user`, `access_token`, `login_time` | |
| **로그아웃** | ✅ | `sessionStorage.clear()` 호출 |

> **평가**: 🟢 **양호** — `localStorage` 대신 `sessionStorage` 사용으로 탭 단위 격리, 이중 타임아웃 구현

---

### 7. 파일 업로드 보안

| 항목 | 상태 | 상세 |
|------|------|------|
| **파일 형식 제한** | ✅ PDF만 허용 | `.pdf` 확장자 검증 |
| **파일 크기 제한** | ✅ 10MB | integrated_interview_server.py |
| **파일명 안전화** | ✅ | `{session_id}_{uuid}.pdf` 형식으로 재명명 |

> **평가**: 🟢 **양호** — 기본적인 업로드 보안 3종 세트 적용

---

### 8. 코드 실행 샌드박스

| 항목 | 값 | 위치 |
|------|-----|------|
| **차단 모듈** | `os`, `subprocess`, `shutil`, `socket`, `requests` | code_execution_service.py |
| **실행 시간 제한** | 10초 | `MAX_EXECUTION_TIME = 10` |
| **출력 크기 제한** | 10,000자 | `MAX_OUTPUT_SIZE = 10000` |
| **실행 방식** | `subprocess.run()` | 별도 프로세스에서 실행 |

> **평가**: 🟡 **보통** — 기본 샌드박싱 적용됨. 단, `SafeImporter`만으로는 우회 가능성 존재 (Docker 격리 미적용)

---

### 9. CORS 설정

```
allow_origins=["*"]
allow_credentials=True
allow_methods=["*"]
allow_headers=["*"]
```
integrated_interview_server.py

> **평가**: 🔴 **위험** — 모든 출처에서의 요청을 허용하여 CSRF 및 크로스사이트 공격에 취약. 운영 환경에서는 반드시 특정 도메인으로 제한 필요

---

### 10. WebSocket 보안

| 항목 | 상태 | 상세 |
|------|------|------|
| **엔드포인트** | `/ws/interview/{session_id}` | STT 실시간 결과 수신 |
| **인증** | ⚠️ 없음 | `session_id`만으로 접속 허용 |
| **TLS** | ⚠️ ws:// | wss:// 미적용 상태 |

> **평가**: 🔴 **위험** — WebSocket에 JWT 토큰 검증 없이 `session_id`만으로 접속 가능. `session_id`를 추측하면 타인의 면접 스트림 수신 가능

---

### 📊 종합 보안 점수표

| 영역 | 등급 | 점수 |
|------|------|------|
| 비밀번호 해싱 | 🟢 양호 | 9/10 |
| API 인증 (JWT) | 🟢 양호 | 8/10 |
| TLS/HTTPS | 🟡 보통 | 5/10 |
| 소셜 로그인 | 🟢 양호 | 8/10 |
| API 키 관리 | 🟢 양호 | 9/10 |
| 세션 관리 | 🟢 양호 | 8/10 |
| 파일 업로드 | 🟢 양호 | 8/10 |
| 코드 실행 샌드박스 | 🟡 보통 | 6/10 |
| CORS | 🔴 위험 | 2/10 |
| WebSocket 보안 | 🔴 위험 | 3/10 |
| **종합** | **🟡 보통** | **66/100** |

---

### 🚨 즉시 조치 권고사항 (우선순위 순)

| 순위 | 항목 | 위험도 | 조치 내용 |
|------|------|--------|-----------|
| **1** | CORS 제한 | 🔴 높음 | `allow_origins=["*"]` → 실제 도메인 목록으로 변경 |
| **2** | WebSocket 인증 | 🔴 높음 | 연결 시 JWT 토큰 검증 추가 |
| **3** | Rate Limiting | 🟠 중간 | 로그인/회원가입 API에 요청 횟수 제한 추가 (brute-force 방지) |
| **4** | TLS 활성화 | 🟠 중간 | 운영 환경에서 HTTPS 적용 (Let's Encrypt 등) |
| **5** | 코드 실행 격리 | 🟠 중간 | Docker 컨테이너 기반 샌드박스 전환 검토 |
| **6** | 소셜 로그인 빈 패스워드 | 🟡 낮음 | 소셜 가입 시 `password_hash`를 랜덤 해시로 설정 |

이 중 **CORS 제한**과 **WebSocket 인증**은 운영 배포 전 반드시 해결해야 할 항목입니다.