# =============================================================================
# NGINX API Gateway 설정 — AI 모의면접 통합 시스템
# =============================================================================
# SAD 설계서: Gateway Layer — 로드 밸런싱, SSL 종단, 라우팅
#
# 아키텍처:
#   Client ──▶ NGINX (80/443) ──┬── /api/*, /ws/* ──▶ FastAPI (8000)
#                                └── /*             ──▶ Next.js (3000)
#
# 실행 방법:
#   1) docker-compose up        (Docker 환경)
#   2) nginx -c nginx.conf      (로컬 설치)
# =============================================================================

# ──────────────────────────────────────────────────────────────────────────────
# 워커 프로세스 설정
# - auto: CPU 코어 수에 맞춰 자동 조절
# ──────────────────────────────────────────────────────────────────────────────
worker_processes auto;

# 에러 로그 경로 및 레벨
error_log /var/log/nginx/error.log warn;
pid       /var/run/nginx.pid;

# ──────────────────────────────────────────────────────────────────────────────
# 이벤트 처리 설정
# - worker_connections: 각 워커가 동시에 처리할 수 있는 최대 연결 수
# ──────────────────────────────────────────────────────────────────────────────
events {
    worker_connections 1024;
}

http {
    # ──────────────────────────────────────────────────────────────────────────
    # 기본 MIME 타입 및 로그 설정
    # ──────────────────────────────────────────────────────────────────────────
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 구조화된 로그 포맷: 추후 ELK/Loki 등 로그 수집에 활용 가능
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time uct=$upstream_connect_time '
                    'uht=$upstream_header_time urt=$upstream_response_time';

    access_log /var/log/nginx/access.log main;

    # ──────────────────────────────────────────────────────────────────────────
    # 성능 최적화
    # ──────────────────────────────────────────────────────────────────────────
    sendfile        on;       # Zero-copy 파일 전송 활성화
    tcp_nopush      on;       # sendfile 사용 시 헤더와 데이터를 함께 전송
    tcp_nodelay     on;       # 소량 패킷도 즉시 전송 (실시간 통신에 중요)
    keepalive_timeout 65;     # Keep-alive 연결 유지 시간 (초)
    types_hash_max_size 2048; # MIME 타입 해시 테이블 크기

    # 요청 바디 크기 제한 (이력서 PDF 업로드 등을 고려하여 50MB)
    client_max_body_size 50m;

    # ──────────────────────────────────────────────────────────────────────────
    # Gzip 압축 설정 — 네트워크 대역폭 절약
    # ──────────────────────────────────────────────────────────────────────────
    gzip              on;
    gzip_vary         on;
    gzip_proxied      any;
    gzip_comp_level   6;       # 압축 레벨 (1-9, 6이 성능/압축률 균형)
    gzip_min_length   256;     # 256바이트 미만은 압축하지 않음
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xml+rss
        image/svg+xml;

    # ──────────────────────────────────────────────────────────────────────────
    # Rate Limiting — DDoS 및 과도한 요청 방지
    # ──────────────────────────────────────────────────────────────────────────
    # 일반 API 요청: IP당 초당 20개 요청 허용 (버스트 40)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;

    # 인증 관련 엔드포인트: IP당 초당 5개 요청 (브루트포스 방지)
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;

    # WebSocket 연결: IP당 초당 5개 연결 (과도한 핸드셰이크 방지)
    limit_req_zone $binary_remote_addr zone=ws_limit:10m rate=5r/s;

    # Rate limit 초과 시 429 응답 코드 반환
    limit_req_status 429;

    # ──────────────────────────────────────────────────────────────────────────
    # Upstream 정의 — 로드 밸런싱 대상 서버
    # ──────────────────────────────────────────────────────────────────────────
    # FastAPI 백엔드 (Core API + Signaling Server)
    # - 수평 확장(Scale-out) 시 여기에 서버를 추가하면 됨
    # - 예: server fastapi-2:8000; server fastapi-3:8000;
    upstream fastapi_backend {
        # least_conn: 가장 적은 연결을 가진 서버로 라우팅 (WebSocket에 유리)
        least_conn;
        server fastapi:8000;
        # ── 수평 확장 예시 (주석 해제하여 사용) ──
        # server fastapi-2:8000;
        # server fastapi-3:8000;
    }

    # Next.js 프론트엔드 서버
    upstream nextjs_frontend {
        server nextjs:3000;
    }

    # ──────────────────────────────────────────────────────────────────────────
    # HTTP → HTTPS 리다이렉트 (포트 80)
    # - 모든 HTTP 요청을 HTTPS로 강제 전환
    # - 보안 강화: 평문 통신을 차단하여 데이터 탈취 방지
    # ──────────────────────────────────────────────────────────────────────────
    server {
        listen 80;
        server_name _;

        # ACME challenge 경로 (Let's Encrypt 인증서 자동 갱신용)
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # 나머지 모든 요청은 HTTPS로 리다이렉트
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ──────────────────────────────────────────────────────────────────────────
    # HTTPS 메인 서버 블록 (포트 443)
    # - SSL 종단(Termination): 클라이언트 ↔ NGINX 구간만 암호화
    # - NGINX ↔ 백엔드 구간은 내부 네트워크이므로 HTTP 사용 (성능 최적화)
    # ──────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;            # HTTP/2 활성화 (멀티플렉싱, 헤더 압축)
        server_name _;

        # ── SSL 인증서 경로 ──
        # 개발 환경: self-signed 인증서 (generate-certs.ps1로 생성)
        # 프로덕션: Let's Encrypt 또는 CA 인증서로 교체
        ssl_certificate     /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;

        # ── SSL 프로토콜 및 암호화 설정 ──
        # TLS 1.2, 1.3만 허용 (TLS 1.0, 1.1은 보안 취약으로 비활성화)
        ssl_protocols TLSv1.2 TLSv1.3;
        
        # 강력한 암호 스위트만 사용 (OWASP 권장)
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        # SSL 세션 캐싱 (핸드셰이크 비용 절감)
        ssl_session_cache   shared:SSL:10m;
        ssl_session_timeout 10m;

        # ── 보안 헤더 ──
        # XSS, 클릭재킹, MIME 스니핑 등 클라이언트 측 공격 방어
        add_header X-Frame-Options        "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection       "1; mode=block" always;
        add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # 서버 버전 정보 숨김 (보안)
        server_tokens off;

        # ──────────────────────────────────────────────────────────────────────
        # 라우팅 1: API 요청 → FastAPI 백엔드
        # ──────────────────────────────────────────────────────────────────────
        # REST API 엔드포인트 (/api/**)
        location /api/ {
            # Rate limiting 적용 (버스트 40, 대기열 없이 초과 시 즉시 거부)
            limit_req zone=api_limit burst=40 nodelay;

            # 프록시 설정
            proxy_pass http://fastapi_backend;

            # 원본 클라이언트 정보를 백엔드로 전달 (Trusted Proxy)
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID      $request_id;

            # 타임아웃 설정 (LLM 추론 등 오래 걸리는 요청 고려)
            proxy_connect_timeout 10s;
            proxy_send_timeout    120s;
            proxy_read_timeout    120s;

            # 프록시 버퍼링: 작은 응답은 메모리에서, 큰 응답은 디스크로
            proxy_buffering       on;
            proxy_buffer_size     4k;
            proxy_buffers         8 16k;
        }

        # 인증 관련 엔드포인트 (더 엄격한 Rate Limiting)
        location /api/auth/ {
            limit_req zone=auth_limit burst=10 nodelay;

            proxy_pass http://fastapi_backend;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID      $request_id;
        }

        # ──────────────────────────────────────────────────────────────────────
        # 라우팅 2: WebSocket 요청 → FastAPI (Signaling Server)
        # ──────────────────────────────────────────────────────────────────────
        # WebSocket 엔드포인트 (/ws/**)
        # - WebRTC 시그널링 (SDP/ICE 교환)
        # - 실시간 면접 채팅
        # - STT 실시간 스트리밍
        location /ws/ {
            limit_req zone=ws_limit burst=10 nodelay;

            proxy_pass http://fastapi_backend;

            # WebSocket 업그레이드 헤더 — 반드시 필요!
            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";

            # 클라이언트 정보 전달
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket 연결 유지 타임아웃 (면접 세션 = 최대 120분)
            proxy_read_timeout    7200s;
            proxy_send_timeout    7200s;
        }

        # ──────────────────────────────────────────────────────────────────────
        # 라우팅 3: 헬스 체크 → FastAPI
        # ──────────────────────────────────────────────────────────────────────
        location = /health {
            proxy_pass http://fastapi_backend;
            proxy_set_header Host $host;

            # 헬스 체크는 빠르게 응답해야 하므로 짧은 타임아웃
            proxy_connect_timeout 5s;
            proxy_read_timeout    5s;
        }

        # ──────────────────────────────────────────────────────────────────────
        # 라우팅 4: 나머지 모든 요청 → Next.js 프론트엔드
        # ──────────────────────────────────────────────────────────────────────
        location / {
            proxy_pass http://nextjs_frontend;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Next.js HMR (Hot Module Replacement) WebSocket 지원
            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # ──────────────────────────────────────────────────────────────────────
        # 정적 파일 캐싱 설정
        # - Next.js가 빌드한 정적 자산(_next/static)은 장기 캐싱
        # ──────────────────────────────────────────────────────────────────────
        location /_next/static/ {
            proxy_pass http://nextjs_frontend;
            proxy_cache_valid 200 365d;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # ──────────────────────────────────────────────────────────────────────
        # NGINX 자체 상태 확인 (모니터링/Prometheus 등에서 사용)
        # ──────────────────────────────────────────────────────────────────────
        location /nginx-health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # ──────────────────────────────────────────────────────────────────────
        # 에러 페이지 설정
        # ──────────────────────────────────────────────────────────────────────
        error_page 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
            internal;
        }
    }
}
