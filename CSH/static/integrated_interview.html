<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>AI ëª¨ì˜ë©´ì ‘ - í†µí•© í™”ìƒ ë©´ì ‘</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #fff;
    }
    
    .header {
      background: rgba(0,0,0,0.3);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
    }
    .header h1 {
      font-size: 24px;
      background: linear-gradient(90deg, #00d9ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header .status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #666;
      animation: pulse 2s infinite;
    }
    .status-dot.connected { background: #00ff88; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .video-panel {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .panel-header {
      padding: 12px 16px;
      background: rgba(0,0,0,0.3);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-header .icon { font-size: 20px; }
    
    /* AI ë©´ì ‘ê´€ íŒ¨ë„ */
    #interviewerContainer {
      width: 100%;
      height: 400px;
      background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .interviewer-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .interviewer-image {
      width: 280px;
      height: 280px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(0, 217, 255, 0.5);
      box-shadow: 0 0 40px rgba(0, 217, 255, 0.3), 0 0 80px rgba(0, 217, 255, 0.1);
      animation: float 4s ease-in-out infinite, glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 40px rgba(0, 217, 255, 0.3), 0 0 80px rgba(0, 217, 255, 0.1); }
      to { box-shadow: 0 0 50px rgba(0, 217, 255, 0.5), 0 0 100px rgba(0, 217, 255, 0.2); }
    }
    
    .interviewer-image.speaking {
      animation: float 4s ease-in-out infinite, speaking-glow 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes speaking-glow {
      from { 
        box-shadow: 0 0 40px rgba(0, 255, 136, 0.4), 0 0 80px rgba(0, 255, 136, 0.2);
        transform: translateY(0px) scale(1);
      }
      to { 
        box-shadow: 0 0 60px rgba(0, 255, 136, 0.6), 0 0 120px rgba(0, 255, 136, 0.3);
        transform: translateY(-4px) scale(1.02);
      }
    }
    
    .voice-waves {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .voice-waves.active { opacity: 1; }
    
    .wave-bar {
      width: 4px;
      background: linear-gradient(to top, #00d9ff, #00ff88);
      border-radius: 2px;
      animation: wave 0.5s ease-in-out infinite;
    }
    .wave-bar:nth-child(1) { height: 20px; animation-delay: 0s; }
    .wave-bar:nth-child(2) { height: 30px; animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { height: 25px; animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { height: 35px; animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { height: 20px; animation-delay: 0.4s; }
    .wave-bar:nth-child(6) { height: 30px; animation-delay: 0.5s; }
    .wave-bar:nth-child(7) { height: 25px; animation-delay: 0.6s; }
    
    @keyframes wave {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.5); }
    }
    
    .interviewer-name {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: rgba(0,0,0,0.6);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .interviewer-name .online-dot {
      width: 8px;
      height: 8px;
      background: #00ff88;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    
    .speaking-indicator {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(0, 217, 255, 0.2);
      border: 1px solid rgba(0, 217, 255, 0.5);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      display: none;
      backdrop-filter: blur(5px);
    }
    .speaking-indicator.active { 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .speaking-indicator .mic-icon {
      animation: mic-pulse 0.5s infinite alternate;
    }
    @keyframes mic-pulse {
      from { transform: scale(1); }
      to { transform: scale(1.2); }
    }
    
    #localVideo {
      width: 100%;
      height: 400px;
      object-fit: cover;
      background: #000;
    }
    
    /* ì±„íŒ… íŒ¨ë„ */
    .chat-panel {
      grid-column: 1 / -1;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      height: 300px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .chat-message {
      margin-bottom: 12px;
      display: flex;
      gap: 10px;
    }
    .chat-message.user { flex-direction: row-reverse; }
    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .chat-message.ai .chat-avatar { background: linear-gradient(135deg, #00d9ff, #00ff88); }
    .chat-message.user .chat-avatar { background: rgba(255,255,255,0.1); }
    .chat-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 12px;
      line-height: 1.4;
      font-size: 14px;
    }
    .chat-message.ai .chat-bubble {
      background: rgba(0,217,255,0.1);
      border: 1px solid rgba(0,217,255,0.2);
    }
    .chat-message.user .chat-bubble {
      background: rgba(255,255,255,0.1);
    }
    .chat-input-area {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .chat-input-area input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 14px;
    }
    .chat-input-area input:focus { outline: none; border-color: #00d9ff; }
    .chat-input-area button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #00d9ff, #00ff88);
      border: none;
      border-radius: 20px;
      color: #1a1a2e;
      font-weight: 600;
      cursor: pointer;
    }
    .chat-input-area button:disabled { opacity: 0.5; }
    
    .control-panel {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      gap: 16px;
      padding: 20px;
    }
    .btn {
      padding: 14px 32px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn-start {
      background: linear-gradient(135deg, #00d9ff, #00ff88);
      color: #1a1a2e;
    }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,217,255,0.4); }
    .btn-stop {
      background: linear-gradient(135deg, #ff4757, #ff6b81);
      color: #fff;
    }
    .btn-stop:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,71,87,0.4); }
    .btn-report {
      background: linear-gradient(135deg, #ffa502, #ff6348);
      color: #fff;
    }
    .btn-dashboard {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      text-decoration: none;
    }
    .btn-dashboard:hover { background: rgba(255,255,255,0.2); }
    
    .info-panel {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    .info-box {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .info-box h3 {
      margin-bottom: 12px;
      font-size: 14px;
      color: #00d9ff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .emotion-bar {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }
    .emotion-label { width: 60px; font-size: 13px; }
    .emotion-progress {
      flex: 1;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 0 12px;
    }
    .emotion-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .emotion-value { width: 40px; text-align: right; font-size: 12px; color: #aaa; }
    
    #logs {
      font-family: 'Consolas', monospace;
      font-size: 12px;
      color: #aaa;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    /* ì„œë¹„ìŠ¤ ìƒíƒœ í‘œì‹œ */
    .service-status {
      display: flex;
      gap: 12px;
      font-size: 12px;
    }
    .service-badge {
      padding: 4px 10px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .service-badge.active { background: rgba(0,255,136,0.2); border: 1px solid #00ff88; }
    .service-badge.inactive { background: rgba(255,71,87,0.2); border: 1px solid #ff4757; }
    
    /* ë©´ì ‘ê´€ ì„ íƒ */
    .interviewer-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    .interviewer-selector select {
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ¯ AI ëª¨ì˜ë©´ì ‘ - í†µí•© ì‹œìŠ¤í…œ</h1>
    <div class="status">
      <div class="service-status" id="serviceStatus"></div>
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">ëŒ€ê¸° ì¤‘</span>
    </div>
  </header>

  <div class="main-container">
    <!-- AI ë©´ì ‘ê´€ -->
    <div class="video-panel">
      <div class="panel-header">
        <span class="icon">ğŸ‘”</span>
        <span>AI ë©´ì ‘ê´€</span>
      </div>
      <div id="interviewerContainer">
        <div class="interviewer-selector">
          <select id="interviewerSelect" onchange="changeInterviewer(this.value)">
            <option value="male1">ê¹€ë¯¼ìˆ˜ ë©´ì ‘ê´€</option>
            <option value="female1">ì´ì„œì—° ë©´ì ‘ê´€</option>
            <option value="male2">ë°•ì¤€í˜ ë©´ì ‘ê´€</option>
            <option value="female2">ìµœì§€í˜„ ë©´ì ‘ê´€</option>
          </select>
        </div>
        <div class="interviewer-wrapper">
          <img id="interviewerImage" class="interviewer-image" 
               src="https://images.unsplash.com/photo-1560250097-0b93528c311a?w=400&h=400&fit=crop&crop=face" 
               alt="AI ë©´ì ‘ê´€">
          <div class="voice-waves" id="voiceWaves">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
          </div>
        </div>
        <div class="interviewer-name">
          <span class="online-dot"></span>
          <span id="interviewerName">ê¹€ë¯¼ìˆ˜ ë©´ì ‘ê´€</span>
        </div>
        <div class="speaking-indicator" id="speakingIndicator">
          <span class="mic-icon">ğŸ¤</span>
          <span>ë§í•˜ëŠ” ì¤‘...</span>
        </div>
      </div>
    </div>

    <!-- ë‚´ ì¹´ë©”ë¼ -->
    <div class="video-panel">
      <div class="panel-header">
        <span class="icon">ğŸ‘¤</span>
        <span>ë‚˜ì˜ í™”ë©´</span>
      </div>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>

    <!-- ì±„íŒ… íŒ¨ë„ -->
    <div class="chat-panel">
      <div class="panel-header">
        <span class="icon">ğŸ’¬</span>
        <span>ë©´ì ‘ ëŒ€í™”</span>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." disabled />
        <button id="sendBtn" disabled>ì „ì†¡</button>
      </div>
    </div>

    <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
    <div class="control-panel">
      <button class="btn btn-start" id="startBtn">
        <span>â–¶</span> ë©´ì ‘ ì‹œì‘
      </button>
      <button class="btn btn-stop" id="stopBtn">
        <span>â¹</span> ì¢…ë£Œ
      </button>
      <button class="btn btn-report" id="reportBtn">
        <span>ğŸ“Š</span> ë¦¬í¬íŠ¸ ìƒì„±
      </button>
      <a class="btn btn-dashboard" id="dashboardLink" href="/static/dashboard.html" target="_blank">
        <span>ğŸ“ˆ</span> ê°ì • ëŒ€ì‹œë³´ë“œ
      </a>
    </div>

    <!-- ì •ë³´ íŒ¨ë„ -->
    <div class="info-panel">
      <div class="info-box">
        <h3>ğŸ“ˆ ì‹¤ì‹œê°„ ê°ì • ë¶„ì„</h3>
        <div id="emotionBox">
          <div class="emotion-bar">
            <span class="emotion-label">í–‰ë³µ</span>
            <div class="emotion-progress"><div class="emotion-fill" id="bar-happy" style="width:0%;background:#00ff88;"></div></div>
            <span class="emotion-value" id="val-happy">0%</span>
          </div>
          <div class="emotion-bar">
            <span class="emotion-label">ì¤‘ë¦½</span>
            <div class="emotion-progress"><div class="emotion-fill" id="bar-neutral" style="width:0%;background:#888;"></div></div>
            <span class="emotion-value" id="val-neutral">0%</span>
          </div>
          <div class="emotion-bar">
            <span class="emotion-label">ìŠ¬í””</span>
            <div class="emotion-progress"><div class="emotion-fill" id="bar-sad" style="width:0%;background:#5a9fd4;"></div></div>
            <span class="emotion-value" id="val-sad">0%</span>
          </div>
          <div class="emotion-bar">
            <span class="emotion-label">ë¶„ë…¸</span>
            <div class="emotion-progress"><div class="emotion-fill" id="bar-angry" style="width:0%;background:#ff4757;"></div></div>
            <span class="emotion-value" id="val-angry">0%</span>
          </div>
          <div class="emotion-bar">
            <span class="emotion-label">ë†€ëŒ</span>
            <div class="emotion-progress"><div class="emotion-fill" id="bar-surprise" style="width:0%;background:#ffa502;"></div></div>
            <span class="emotion-value" id="val-surprise">0%</span>
          </div>
          <div class="emotion-bar">
            <span class="emotion-label">ê³µí¬</span>
            <div class="emotion-progress"><div class="emotion-fill" id="bar-fear" style="width:0%;background:#a55eea;"></div></div>
            <span class="emotion-value" id="val-fear">0%</span>
          </div>
          <div class="emotion-bar">
            <span class="emotion-label">í˜ì˜¤</span>
            <div class="emotion-progress"><div class="emotion-fill" id="bar-disgust" style="width:0%;background:#2ed573;"></div></div>
            <span class="emotion-value" id="val-disgust">0%</span>
          </div>
        </div>
      </div>
      <div class="info-box">
        <h3>ğŸ“‹ ì‹œìŠ¤í…œ ë¡œê·¸</h3>
        <div id="logs"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== ìƒíƒœ ë³€ìˆ˜ ==========
    let sessionId = null;
    let pc = null;
    let localStream = null;
    let emotionTimer = null;
    let currentAudio = null;
    
    // ========== DOM ìš”ì†Œ ==========
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const reportBtn = document.getElementById('reportBtn');
    
    // ========== ë©´ì ‘ê´€ ë°ì´í„° ==========
    const interviewers = {
      male1: { name: 'ê¹€ë¯¼ìˆ˜ ë©´ì ‘ê´€', image: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=400&h=400&fit=crop&crop=face' },
      female1: { name: 'ì´ì„œì—° ë©´ì ‘ê´€', image: 'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?w=400&h=400&fit=crop&crop=face' },
      male2: { name: 'ë°•ì¤€í˜ ë©´ì ‘ê´€', image: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop&crop=face' },
      female2: { name: 'ìµœì§€í˜„ ë©´ì ‘ê´€', image: 'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=400&h=400&fit=crop&crop=face' }
    };
    
    function changeInterviewer(key) {
      const interviewer = interviewers[key];
      if (interviewer) {
        document.getElementById('interviewerImage').src = interviewer.image;
        document.getElementById('interviewerName').textContent = interviewer.name;
        log('ë©´ì ‘ê´€ ë³€ê²½: ' + interviewer.name);
      }
    }
    
    // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
    function log(msg) {
      const box = document.getElementById('logs');
      const time = new Date().toLocaleTimeString();
      box.textContent += `[${time}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    }
    
    function updateStatus(connected) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      if (connected) {
        dot.classList.add('connected');
        text.textContent = 'ë©´ì ‘ ì§„í–‰ ì¤‘';
      } else {
        dot.classList.remove('connected');
        text.textContent = 'ëŒ€ê¸° ì¤‘';
      }
    }
    
    function setInterviewerSpeaking(isSpeaking) {
      const img = document.getElementById('interviewerImage');
      const indicator = document.getElementById('speakingIndicator');
      const waves = document.getElementById('voiceWaves');
      if (isSpeaking) {
        img.classList.add('speaking');
        indicator.classList.add('active');
        waves.classList.add('active');
      } else {
        img.classList.remove('speaking');
        indicator.classList.remove('active');
        waves.classList.remove('active');
      }
    }
    
    // ========== ì±„íŒ… ê¸°ëŠ¥ ==========
    function addChatMessage(content, isUser = false) {
      const div = document.createElement('div');
      div.className = 'chat-message ' + (isUser ? 'user' : 'ai');
      div.innerHTML = `
        <div class="chat-avatar">${isUser ? 'ğŸ‘¤' : 'ğŸ‘”'}</div>
        <div class="chat-bubble">${content}</div>
      `;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message || !sessionId) return;
      
      addChatMessage(message, true);
      chatInput.value = '';
      sendBtn.disabled = true;
      
      try {
        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, message, use_rag: true })
        });
        const data = await resp.json();
        addChatMessage(data.response);
        
        // TTSë¡œ ìŒì„± ì¬ìƒ
        await speakText(data.response);
        
        // ì˜¤ë””ì˜¤ íŒŒì¼ì´ ìˆìœ¼ë©´ ì¬ìƒ
        if (data.audio_url) {
          playAudio(data.audio_url);
        }
      } catch (e) {
        log('ì±„íŒ… ì˜¤ë¥˜: ' + e);
        addChatMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
      
      sendBtn.disabled = false;
    }
    
    // ========== TTS ê¸°ëŠ¥ ==========
    async function speakText(text) {
      try {
        setInterviewerSpeaking(true);
        
        const resp = await fetch('/tts/speak', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, emotion: 'neutral' })
        });
        
        if (resp.ok) {
          const audioBlob = await resp.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }
          
          currentAudio = new Audio(audioUrl);
          currentAudio.onended = () => {
            setInterviewerSpeaking(false);
            URL.revokeObjectURL(audioUrl);
          };
          currentAudio.onerror = () => setInterviewerSpeaking(false);
          await currentAudio.play();
        } else {
          setTimeout(() => setInterviewerSpeaking(false), 2000);
        }
      } catch (e) {
        console.error('TTS Error:', e);
        setTimeout(() => setInterviewerSpeaking(false), 2000);
      }
    }
    
    function playAudio(url) {
      const audio = new Audio(url);
      audio.play().catch(e => console.error('Audio play error:', e));
    }
    
    // ========== ê°ì • ë¶„ì„ ==========
    function updateEmotionBars(probabilities) {
      const emotions = ['happy', 'neutral', 'sad', 'angry', 'surprise', 'fear', 'disgust'];
      emotions.forEach(emotion => {
        const value = Math.round((probabilities[emotion] || 0) * 100);
        const bar = document.getElementById(`bar-${emotion}`);
        const val = document.getElementById(`val-${emotion}`);
        if (bar) bar.style.width = value + '%';
        if (val) val.textContent = value + '%';
      });
    }
    
    async function pollEmotion() {
      try {
        const r = await fetch('/emotion');
        const j = await r.json();
        if (j.status !== 'no_data' && j.probabilities) {
          updateEmotionBars(j.probabilities);
        }
      } catch (e) {}
    }
    
    // ========== ë©´ì ‘ ì‹œì‘/ì¢…ë£Œ ==========
    async function startInterview() {
      try {
        // 1. ì„¸ì…˜ ìƒì„±
        const sessionResp = await fetch('/api/session', { method: 'POST' });
        const sessionData = await sessionResp.json();
        sessionId = sessionData.session_id;
        log('ì„¸ì…˜ ìƒì„±: ' + sessionId);
        
        // 2. ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: { echoCancellation: true, noiseSuppression: true }
        });
        document.getElementById('localVideo').srcObject = localStream;
        log('ì¹´ë©”ë¼ ë° ë§ˆì´í¬ ì—°ê²°ë¨');
        
        // 3. WebRTC ì—°ê²°
        pc = new RTCPeerConnection();
        pc.onconnectionstatechange = () => {
          log(`WebRTC ìƒíƒœ: ${pc.connectionState}`);
          updateStatus(pc.connectionState === 'connected');
        };
        
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        const offerResp = await fetch('/offer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sdp: offer.sdp, type: offer.type })
        });
        
        if (!offerResp.ok) throw new Error('WebRTC ì—°ê²° ì‹¤íŒ¨');
        
        const answer = await offerResp.json();
        await pc.setRemoteDescription(answer);
        log('WebRTC ì—°ê²° ì™„ë£Œ');
        
        // 4. ì±„íŒ… í™œì„±í™”
        chatInput.disabled = false;
        sendBtn.disabled = false;
        
        // 5. ì´ˆê¸° ì¸ì‚¬ë§ í‘œì‹œ
        addChatMessage(sessionData.greeting);
        await speakText(sessionData.greeting);
        
        // 6. ê°ì • í´ë§ ì‹œì‘
        emotionTimer = setInterval(pollEmotion, 1000);
        
        // 7. ëŒ€ì‹œë³´ë“œ ë§í¬ ì—…ë°ì´íŠ¸
        document.getElementById('dashboardLink').href = `/static/dashboard.html?session_id=${sessionId}`;
        
        updateStatus(true);
        
      } catch (err) {
        log('ì‹œì‘ ì˜¤ë¥˜: ' + err.message);
        console.error(err);
      }
    }
    
    async function stopInterview() {
      try {
        if (pc) pc.close();
        if (localStream) localStream.getTracks().forEach(t => t.stop());
        if (emotionTimer) { clearInterval(emotionTimer); emotionTimer = null; }
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        
        chatInput.disabled = true;
        sendBtn.disabled = true;
        setInterviewerSpeaking(false);
        updateStatus(false);
        log('ë©´ì ‘ ì¢…ë£Œ');
      } catch (e) {
        log('ì¢…ë£Œ ì˜¤ë¥˜: ' + e);
      }
    }
    
    async function generateReport() {
      if (!sessionId) {
        alert('ë©´ì ‘ì„ ë¨¼ì € ì‹œì‘í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        log('ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...');
        const resp = await fetch(`/api/report/${sessionId}`);
        const report = await resp.json();
        
        let reportHtml = '<strong>ğŸ“Š ë©´ì ‘ ë¦¬í¬íŠ¸</strong><br>';
        reportHtml += `ì´ ë‹µë³€: ${report.metrics.total}íšŒ<br>`;
        reportHtml += `í‰ê·  ê¸¸ì´: ${report.metrics.avg_length}ì<br>`;
        reportHtml += '<strong>í”¼ë“œë°±:</strong><br>';
        report.feedback.forEach(f => { reportHtml += `â€¢ ${f}<br>`; });
        
        addChatMessage(reportHtml);
        log('ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ');
      } catch (e) {
        log('ë¦¬í¬íŠ¸ ì˜¤ë¥˜: ' + e);
      }
    }
    
    // ========== ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ==========
    async function checkServiceStatus() {
      try {
        const resp = await fetch('/api/status');
        const status = await resp.json();
        
        const container = document.getElementById('serviceStatus');
        container.innerHTML = '';
        
        const services = [
          { key: 'llm', name: 'LLM' },
          { key: 'tts', name: 'TTS' },
          { key: 'rag', name: 'RAG' },
          { key: 'emotion', name: 'ê°ì •' }
        ];
        
        services.forEach(s => {
          const active = status.services[s.key];
          const badge = document.createElement('span');
          badge.className = 'service-badge ' + (active ? 'active' : 'inactive');
          badge.textContent = s.name + (active ? ' âœ“' : ' âœ—');
          container.appendChild(badge);
        });
        
        log('ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì™„ë£Œ');
      } catch (e) {
        log('ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨');
      }
    }
    
    // ========== ì´ë²¤íŠ¸ ë°”ì¸ë”© ==========
    startBtn.onclick = startInterview;
    stopBtn.onclick = stopInterview;
    reportBtn.onclick = generateReport;
    sendBtn.onclick = sendMessage;
    chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
    
    // ========== ì´ˆê¸°í™” ==========
    (async function init() {
      log('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
      await checkServiceStatus();
      log('ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. ë©´ì ‘ ì‹œì‘ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
    })();
  </script>
</body>
</html>
