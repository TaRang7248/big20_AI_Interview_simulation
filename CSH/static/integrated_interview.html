<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í™”ìƒ ë©´ì ‘ - ìŒì„± ì¸í„°ë·°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-badge.ready { background: rgba(0,255,136,0.2); color: #00ff88; }
        .status-badge.listening { background: rgba(255,193,7,0.2); color: #ffc107; }
        .status-badge.speaking { background: rgba(0,217,255,0.2); color: #00d9ff; }
        .status-badge.processing { background: rgba(156,39,176,0.2); color: #ce93d8; }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }
        
        .btn-danger {
            background: rgba(244,67,54,0.8);
            color: #fff;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* ë¹„ë””ì˜¤ íŒ¨ë„ */
        .video-panel {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .panel-header .icon { font-size: 20px; }
        
        /* AI ë©´ì ‘ê´€ íŒ¨ë„ */
        .interviewer-container {
            position: relative;
            background: linear-gradient(135deg, #1e3a5f, #0d2137);
            border-radius: 12px;
            aspect-ratio: 16/10;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .interviewer-avatar, #didVideo {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            border: 4px solid #00d9ff;
            object-fit: cover;
            transition: all 0.3s;
        }
        
        .interviewer-avatar:hover, #didVideo:hover {
            transform: scale(1.05);
            border-color: #fff;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.8);
        }
        
        .interviewer-avatar.speaking, #didVideo.speaking {
            border-color: #00ff88;
            box-shadow: 0 0 30px rgba(0,255,136,0.5);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .interviewer-name {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0,0,0,0.6);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .interviewer-name .dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
        }
        
        /* ìŒì„± íŒŒí˜• ì‹œê°í™” */
        .voice-visualizer {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 40px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .voice-visualizer.active { opacity: 1; }
        
        .voice-bar {
            width: 4px;
            background: #00ff88;
            border-radius: 2px;
            animation: voiceWave 0.5s ease-in-out infinite;
        }
        
        @keyframes voiceWave {
            0%, 100% { height: 10px; }
            50% { height: 35px; }
        }
        
        .voice-bar:nth-child(1) { animation-delay: 0s; }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { animation-delay: 0.4s; }
        .voice-bar:nth-child(6) { animation-delay: 0.3s; }
        .voice-bar:nth-child(7) { animation-delay: 0.2s; }
        .voice-bar:nth-child(8) { animation-delay: 0.1s; }
        
        /* ì‚¬ìš©ì ë¹„ë””ì˜¤ */
        #userVideo {
            width: 100%;
            border-radius: 12px;
            background: #000;
            aspect-ratio: 16/10;
        }
        
        /* ì¸í„°ë·° ìƒíƒœ íŒ¨ë„ */
        .interview-status-panel {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
        }
        
        .current-question {
            background: rgba(0,217,255,0.1);
            border: 1px solid rgba(0,217,255,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .current-question-label {
            font-size: 12px;
            color: #00d9ff;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .current-question-text {
            font-size: 18px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* ìŒì„± ì¸ì‹ ìƒíƒœ */
        .speech-status {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .mic-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }
        
        .mic-indicator.listening {
            background: rgba(244,67,54,0.3);
            animation: micPulse 1.5s infinite;
        }
        
        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244,67,54,0.4); }
            50% { box-shadow: 0 0 0 20px rgba(244,67,54,0); }
        }
        
        .speech-content {
            flex: 1;
        }
        
        .speech-label {
            font-size: 12px;
            color: #8892b0;
            margin-bottom: 6px;
        }
        
        .speech-text {
            font-size: 16px;
            color: #fff;
            min-height: 24px;
        }
        
        .speech-text.placeholder {
            color: #8892b0;
            font-style: italic;
        }
        
        /* ì»¨íŠ¸ë¡¤ ë°” */
        .controls-bar {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn.mic {
            background: #4CAF50;
            color: #fff;
        }
        
        .control-btn.mic.muted {
            background: #f44336;
        }
        
        .control-btn.camera {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        
        .control-btn.camera.off {
            background: #f44336;
        }
        
        .control-btn.end-call {
            background: #f44336;
            color: #fff;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        /* ì‚¬ì´ë“œ íŒ¨ë„ */
        .side-panel {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 300px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
        }
        
        .evaluation-scores {
            margin-top: 15px;
        }
        
        .score-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .score-label {
            width: 80px;
            font-size: 12px;
            color: #8892b0;
        }
        
        .score-bar {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        .score-value {
            width: 30px;
            text-align: right;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* ê°ì • ë¶„ì„ */
        .emotion-display {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .emotion-title {
            font-size: 14px;
            margin-bottom: 12px;
            color: #8892b0;
        }
        
        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .emotion-item {
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        /* ì´ë ¥ì„œ ì—…ë¡œë“œ ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #00d9ff;
            background: rgba(0,217,255,0.05);
        }
        
        .upload-area.dragover {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }
        
        .upload-icon { font-size: 48px; margin-bottom: 16px; }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        /* ì§„í–‰ ìƒíƒœ í‘œì‹œ */
        .progress-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .progress-step {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-step.completed {
            background: #00ff88;
        }
        
        .progress-step.current {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            animation: progressPulse 1.5s infinite;
        }
        
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ê°œì… ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* ë‹µë³€ ì‹œê°„ ì§„í–‰ í‘œì‹œ */
        .answer-timer {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 20px;
            border-radius: 20px;
            color: #8892b0;
            font-size: 14px;
            z-index: 9999;
            display: none;
        }
        
        .answer-timer.warning {
            color: #f39c12;
            border: 1px solid #f39c12;
        }
        
        .answer-timer.danger {
            color: #e74c3c;
            border: 1px solid #e74c3c;
            animation: progressPulse 0.5s infinite;
        }

        .question-counter {
            text-align: center;
            color: #8892b0;
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- ë‹µë³€ ì‹œê°„ íƒ€ì´ë¨¸ -->
    <div class="answer-timer" id="answerTimer">
        <span id="answerTimerText">ë‹µë³€ ì‹œê°„: 0ì´ˆ</span>
    </div>
    
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ¯ AI í™”ìƒ ë©´ì ‘</h1>
            <div class="header-controls">
                <!-- ì‚¬ìš©ì ì •ë³´ -->
                <div class="user-info" id="headerUserInfo" style="display:flex; align-items:center; gap:10px; margin-right:15px;">
                    <span style="color:#00ff88;">ğŸ‘¤</span>
                    <span id="headerUserName" style="color:#8892b0; font-size:14px;"></span>
                    <button class="btn" style="padding:6px 12px; font-size:12px; background:rgba(244,67,54,0.6);" onclick="logoutAndRedirect()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <span class="status-badge ready" id="statusBadge">ì¤€ë¹„ ì™„ë£Œ</span>
                <button class="btn btn-primary" id="startBtn">ë©´ì ‘ ì‹œì‘</button>
                <button class="btn btn-danger" id="endBtn" style="display:none;">ë©´ì ‘ ì¢…ë£Œ</button>
            </div>
        </div>
        
        <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
        <div class="main-layout">
            <!-- AI ë©´ì ‘ê´€ -->
            <div class="video-panel">
                <div class="panel-header">
                    <span class="icon">ğŸ¤–</span>
                    <span>AI ë©´ì ‘ê´€</span>
                    <span class="did-badge" id="didBadge" style="display:none; margin-left:auto; font-size:10px; background:rgba(0,255,136,0.2); padding:4px 8px; border-radius:10px; color:#00ff88;">AI Avatar</span>
                </div>
                <div class="interviewer-container">
                    <!-- D-ID AI ì•„ë°”íƒ€ ë¹„ë””ì˜¤ (ê¸°ë³¸ í‘œì‹œ) -->
                    <video id="didVideo" 
                           autoplay 
                           playsinline
                           muted
                           loop
                           poster="https://create-images-results.d-id.com/api_docs/assets/noelle.jpeg"
                           style="width:100%; height:100%; object-fit:cover; border-radius:12px;">
                    </video>
                    <!-- D-ID ì—°ê²° ëŒ€ê¸° ìƒíƒœ í‘œì‹œ -->
                    <div id="didLoadingOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); border-radius:12px;">
                        <div style="width:60px; height:60px; border:4px solid rgba(0,217,255,0.3); border-top-color:#00d9ff; border-radius:50%; animation:spin 1s linear infinite;"></div>
                        <div id="didLoadingText" style="margin-top:15px; color:#00d9ff; font-size:16px;">AI ë©´ì ‘ ì¤€ë¹„ì¤‘</div>
                    </div>
                    <style>
                        @keyframes spin { to { transform: rotate(360deg); } }
                    </style>
                    <div class="interviewer-name" id="interviewerName">
                        <span class="dot"></span>
                        <span>AI ë©´ì ‘ê´€</span>
                    </div>
                    <div class="voice-visualizer" id="voiceVisualizer">
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                    </div>
                </div>
            </div>
            
            <!-- ì‚¬ìš©ì í™”ë©´ -->
            <div class="video-panel">
                <div class="panel-header">
                    <span class="icon">ğŸ‘¤</span>
                    <span>ë‚˜ì˜ í™”ë©´</span>
                </div>
                <video id="userVideo" autoplay muted playsinline></video>
            </div>
            
            <!-- ì¸í„°ë·° ìƒíƒœ íŒ¨ë„ -->
            <div class="interview-status-panel">
                <!-- ì§„í–‰ ìƒíƒœ -->
                <div class="question-counter" id="questionCounter">ì§ˆë¬¸ 0/9</div>
                <div class="progress-indicator" id="progressIndicator">
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                    <div class="progress-step"></div>
                </div>
                
                <!-- í˜„ì¬ ì§ˆë¬¸ -->
                <div class="current-question">
                    <div class="current-question-label">í˜„ì¬ ì§ˆë¬¸</div>
                    <div class="current-question-text" id="currentQuestion">
                        ë©´ì ‘ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </div>
                </div>
                
                <!-- ìŒì„± ì¸ì‹ ìƒíƒœ -->
                <div class="speech-status">
                    <div class="mic-indicator" id="micIndicator">ğŸ¤</div>
                    <div class="speech-content">
                        <div class="speech-label">ìŒì„± ì¸ì‹ ì¤‘...</div>
                        <div class="speech-text placeholder" id="speechText">
                            ë§ˆì´í¬ê°€ í™œì„±í™”ë˜ë©´ ìŒì„±ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
                
                <!-- ì»¨íŠ¸ë¡¤ ë°” -->
                <div class="controls-bar">
                    <button class="control-btn mic" id="micBtn" onclick="toggleMic()">ğŸ¤</button>
                    <button class="control-btn camera" id="cameraBtn" onclick="toggleCamera()">ğŸ“¹</button>
                    <button class="control-btn end-call" onclick="endInterview()">ğŸ“</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì‚¬ì´ë“œ íŒ¨ë„ - í‰ê°€ ì •ë³´ (ë¹„í™œì„±í™”ë¨) -->
    <!-- ì‹¤ì‹œê°„ í‰ê°€ íŒ¨ë„ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ë©´ì ‘ ì¢…ë£Œ í›„ ë¦¬í¬íŠ¸ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. -->
    
    <!-- ì´ë ¥ì„œ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="resumeModal">
        <div class="modal">
            <h2>ğŸ“„ ì´ë ¥ì„œ ì—…ë¡œë“œ</h2>
            <p style="color: #8892b0; margin-bottom: 20px;">
                ì´ë ¥ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ë§ì¶¤í˜• ë©´ì ‘ ì§ˆë¬¸ì„ ì œê³µí•©ë‹ˆë‹¤.
            </p>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('resumeFile').click()">
                <div class="upload-icon">ğŸ“</div>
                <p>PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                <p style="color: #8892b0; font-size: 14px; margin-top: 10px;" id="fileName"></p>
            </div>
            <input type="file" id="resumeFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
            <div class="modal-buttons">
                <button class="btn" style="background: rgba(255,255,255,0.1); color: #8892b0;" onclick="skipResume()">ê±´ë„ˆë›°ê¸°</button>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadResume()" disabled>ì—…ë¡œë“œ í›„ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <script>
        // ========== ì „ì—­ ìƒíƒœ ==========
        let sessionId = null;
        let mediaStream = null;
        let isInterviewActive = false;
        let isMicMuted = false;
        let isCameraOff = false;
        let currentQuestionIndex = 0;
        let recognition = null;
        let isListening = false;
        let currentQuestion = '';
        let speechBuffer = '';
        let silenceTimer = null;
        
        // D-ID ê´€ë ¨ ìƒíƒœ
        let didAvailable = false;
        let didPeerConnection = null;
        let didDataChannel = null;
        let didStreamReady = false;
        let didStreamId = null;
        let didSessionId = null;
        let didIceServers = [];
        let didVideoTrack = null;
        let didAudioTrack = null;
        let isSpeaking = false;
        
        // D-ID ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ ì„¤ì • (true: Streaming API, false: Talks API)
        const USE_STREAMING_API = true;
        
        // ========== ì‚¬ìš©ì ì˜ìƒ/ìŒì„± WebRTC ìƒíƒœ ==========
        let userPeerConnection = null;  // ì‚¬ìš©ì ì˜ìƒ/ìŒì„±ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” WebRTC
        let userWebSocket = null;       // ì„œë²„ STT ê²°ê³¼ ìˆ˜ì‹ ìš© WebSocket
        let serverSTTEnabled = false;   // ì„œë²„ STT í™œì„±í™” ì—¬ë¶€
        
        // ========== STT ì„¤ì • ==========
        // Deepgram(ì„œë²„ STT)ì„ í•­ìƒ ìš°ì„  ì‚¬ìš©
        // Web Speech APIëŠ” Deepgram ì—°ê²° ì‹¤íŒ¨ ì‹œì—ë§Œ í´ë°±ìœ¼ë¡œ ì‚¬ìš©
        const PREFER_SERVER_STT = true;  // true: Deepgram ìš°ì„ , false: Web Speech API ìš°ì„ 
        let useServerSTT = PREFER_SERVER_STT;
        
        // ========== ì‹¤ì‹œê°„ ê°œì… ì‹œìŠ¤í…œ ìƒíƒœ ==========
        let interventionEnabled = true;
        let interventionCheckInterval = null;
        let currentTurnStartTime = null;
        let answerLengthSoFar = 0;
        let lastVADSignalTime = null;
        let hasReceivedSoftWarning = false;
        let interventionSettings = {
            max_answer_time: 120,
            soft_warning_time: 90,
            max_answer_length: 800,
            topic_relevance_threshold: 0.3
        };
        
        // ========== í™”ì´íŠ¸ë³´ë“œ ìƒíƒœ ==========
        let whiteboardCanvas = null;
        let whiteboardCtx = null;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#00d9ff';
        let lineWidth = 3;
        let lastX = 0;
        let lastY = 0;
        let drawHistory = [];
        let historyIndex = -1;
        let currentArchProblem = null;
        let whiteboardResults = [];
        
        // ë¡œê·¸ì¸ ìƒíƒœ
        let currentUser = null;
        
        // ========== ë¡œê·¸ì¸ í™•ì¸ ==========
        function checkLoginStatus() {
            const userData = localStorage.getItem('interview_user');
            if (!userData) {
                return null;
            }
            try {
                return JSON.parse(userData);
            } catch (e) {
                return null;
            }
        }
        
        function logoutAndRedirect() {
            localStorage.removeItem('interview_user');
            localStorage.removeItem('login_time');
            alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        }
        
        function updateHeaderUserInfo() {
            const userInfoEl = document.getElementById('headerUserInfo');
            const userNameEl = document.getElementById('headerUserName');
            if (currentUser) {
                userNameEl.textContent = currentUser.name + 'ë‹˜';
                userInfoEl.style.display = 'flex';
            } else {
                userInfoEl.style.display = 'none';
            }
        }
        
        // ========== ì´ˆê¸°í™” ==========
        document.addEventListener('DOMContentLoaded', async () => {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ - ë¯¸ë¡œê·¸ì¸ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            currentUser = checkLoginStatus();
            if (!currentUser) {
                alert('ë©´ì ‘ì„ ì§„í–‰í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
            } else {
                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                updateHeaderUserInfo();
                
                // ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                document.getElementById('startBtn').addEventListener('click', startInterview);
                document.getElementById('endBtn').addEventListener('click', endInterview);
                
                await initCamera();
                await checkDIDAvailability();
                initSpeechRecognition();
            }
        });
        
        // ========== D-ID ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ==========
        async function checkDIDAvailability() {
            const loadingText = document.getElementById('didLoadingText');
            try {
                const response = await fetch('/api/did/status');
                const result = await response.json();
                didAvailable = result.available;
                
                if (didAvailable) {
                    document.getElementById('didBadge').style.display = 'block';
                    loadingText.textContent = 'AI ë©´ì ‘ ì¤€ë¹„ì¤‘';
                    console.log('âœ… D-ID AI ì•„ë°”íƒ€ ì‚¬ìš© ê°€ëŠ¥');
                } else {
                    loadingText.textContent = 'D-ID API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
                    console.log('âš ï¸ D-ID ë¯¸ì„¤ì •');
                }
            } catch (err) {
                console.log('âš ï¸ D-ID ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', err);
                loadingText.textContent = 'D-ID ì—°ê²° í™•ì¸ ì‹¤íŒ¨';
                didAvailable = false;
            }
        }
        
        // ========== ë¡œë”© ì˜¤ë²„ë ˆì´ ì œì–´ ==========
        function hideDIDLoadingOverlay() {
            const overlay = document.getElementById('didLoadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        function showDIDLoadingOverlay(message=None) {
            const overlay = document.getElementById('didLoadingOverlay');
            const text = document.getElementById('didLoadingText');
            if (overlay) {
                overlay.style.display = 'flex';
                if (text) text.textContent = message;
            }
        }
        
        // ========== D-ID Streaming API ì´ˆê¸°í™” (WebRTC) ==========
        async function initDIDStreaming() {
            if (!didAvailable) {
                showDIDLoadingOverlay('D-ID API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return false;
            }
            
            showDIDLoadingOverlay('AI ë©´ì ‘ ì¤€ë¹„ì¤‘');
            
            // Talks API ëª¨ë“œë©´ ì´ˆê¸°í™” ë¶ˆí•„ìš”
            if (!USE_STREAMING_API) {
                console.log('âœ… D-ID Talks API ëª¨ë“œ ì‚¬ìš© ì¤€ë¹„ ì™„ë£Œ');
                didStreamReady = true;
                hideDIDLoadingOverlay();
                return true;
            }
            
            console.log('ğŸ”„ D-ID Streaming API ì´ˆê¸°í™” ì¤‘...');
            
            try {
                // 1. ìŠ¤íŠ¸ë¦¼ ìƒì„± ìš”ì²­ - SDP Offer ë°›ê¸°
                const response = await fetch('/api/did/stream/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                if (!response.ok) {
                    console.warn('D-ID ìŠ¤íŠ¸ë¦¼ ìƒì„± ì‹¤íŒ¨');
                    return false;
                }
                
                const result = await response.json();
                didStreamId = result.stream_id;
                didSessionId = result.session_id;
                didIceServers = result.ice_servers || [];
                const offer = result.offer;
                
                console.log('âœ… D-ID ìŠ¤íŠ¸ë¦¼ ìƒì„±ë¨:', didStreamId);
                
                // 2. WebRTC PeerConnection ìƒì„±
                const config = {
                    iceServers: didIceServers.length > 0 ? didIceServers : [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                };
                
                didPeerConnection = new RTCPeerConnection(config);
                
                // 3. ICE Candidate ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                didPeerConnection.onicecandidate = async (event) => {
                    if (event.candidate) {
                        try {
                            await fetch('/api/did/stream/ice', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    session_id: sessionId,
                                    candidate: {
                                        candidate: event.candidate.candidate,
                                        sdpMid: event.candidate.sdpMid,
                                        sdpMLineIndex: event.candidate.sdpMLineIndex
                                    }
                                })
                            });
                        } catch (err) {
                            console.warn('ICE candidate ì „ì†¡ ì‹¤íŒ¨:', err);
                        }
                    }
                };
                
                // 4. íŠ¸ë™ ìˆ˜ì‹  ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                didPeerConnection.ontrack = (event) => {
                    console.log('ğŸ¬ D-ID ìŠ¤íŠ¸ë¦¼ íŠ¸ë™ ìˆ˜ì‹ :', event.track.kind);
                    
                    const didVideo = document.getElementById('didVideo');
                    
                    if (event.track.kind === 'video') {
                        didVideoTrack = event.track;
                        // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì„¤ì •
                        if (event.streams && event.streams[0]) {
                            didVideo.srcObject = event.streams[0];
                        } else {
                            const stream = new MediaStream([event.track]);
                            didVideo.srcObject = stream;
                        }
                    }
                    
                    if (event.track.kind === 'audio') {
                        didAudioTrack = event.track;
                        // ì˜¤ë””ì˜¤ íŠ¸ë™ë„ ê°™ì€ ìŠ¤íŠ¸ë¦¼ì— ì—°ê²°
                        if (didVideo.srcObject && didAudioTrack) {
                            didVideo.srcObject.addTrack(didAudioTrack);
                        }
                    }
                };
                
                // 5. ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                didPeerConnection.onconnectionstatechange = () => {
                    console.log('D-ID ì—°ê²° ìƒíƒœ:', didPeerConnection.connectionState);
                    
                    if (didPeerConnection.connectionState === 'connected') {
                        didStreamReady = true;
                        console.log('âœ… D-ID WebRTC ì—°ê²° ì™„ë£Œ');
                        
                        const didVideo = document.getElementById('didVideo');
                        didVideo.muted = false;  // ì˜¤ë””ì˜¤ í™œì„±í™”
                        hideDIDLoadingOverlay();  // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
                    } else if (didPeerConnection.connectionState === 'failed' || 
                               didPeerConnection.connectionState === 'disconnected') {
                        console.warn('âš ï¸ D-ID ì—°ê²° ì‹¤íŒ¨/ëŠê¹€');
                        didStreamReady = false;
                        showDIDLoadingOverlay('D-ID ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
                    }
                };
                
                // 6. Remote Description ì„¤ì • (D-IDì˜ Offer)
                await didPeerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // 7. Answer ìƒì„±
                const answer = await didPeerConnection.createAnswer();
                await didPeerConnection.setLocalDescription(answer);
                
                // 8. SDP Answerë¥¼ ì„œë²„ë¡œ ì „ì†¡
                const sdpResponse = await fetch('/api/did/stream/sdp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        answer: {
                            type: answer.type,
                            sdp: answer.sdp
                        }
                    })
                });
                
                if (!sdpResponse.ok) {
                    console.warn('SDP Answer ì „ì†¡ ì‹¤íŒ¨');
                    return false;
                }
                
                console.log('âœ… D-ID SDP êµí™˜ ì™„ë£Œ');
                
                // 9. ìŠ¤íŠ¸ë¦¼ ì‹œì‘
                await fetch('/api/did/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                console.log('âœ… D-ID ìŠ¤íŠ¸ë¦¬ë° ì¤€ë¹„ ì™„ë£Œ (WebRTC)');
                // ì—°ê²° ì™„ë£Œë˜ë©´ ì˜¤ë²„ë ˆì´ëŠ” onconnectionstatechangeì—ì„œ ìˆ¨ê¹€
                return true;
                
            } catch (err) {
                console.error('D-ID ìŠ¤íŠ¸ë¦¬ë° ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
                didStreamReady = false;
                showDIDLoadingOverlay('D-ID ì—°ê²° ì‹¤íŒ¨: ' + err.message);
                return false;
            }
        }
        
        // ========== D-ID ì•„ë°”íƒ€ê°€ ë§í•˜ê²Œ í•¨ (ì˜ìƒë§Œ - ìŒì„±ì€ Hume TTS) ==========
        // D-ID: ë¦½ì‹±í¬ ì˜ìƒ ë‹´ë‹¹
        // Hume EVI: ìŒì„± ë‹´ë‹¹ (ë¶„ë¦¬ëœ ì—­í• )
        async function didSpeak(text) {
            if (!didAvailable) {
                return false;
            }
            
            // Streaming API ëª¨ë“œ
            if (USE_STREAMING_API && didStreamReady && didPeerConnection) {
                return await didSpeakStreamingWithHumeTTS(text);
            }
            
            // Talks API ëª¨ë“œ (í´ë°±)
            return await didSpeakTalksWithHumeTTS(text);
        }
        
        // ========== D-ID Streaming + Hume TTS ë™ì‹œ ë°œí™” ==========
        async function didSpeakStreamingWithHumeTTS(text) {
            try {
                console.log('ğŸ¬ D-ID ì˜ìƒ + Hume TTS ë™ì‹œ ë°œí™”:', text.substring(0, 30) + '...');
                
                const didVideo = document.getElementById('didVideo');
                
                // ë°œí™” ì¤‘ ìŠ¤íƒ€ì¼ ì ìš©
                didVideo.classList.add('speaking');
                isSpeaking = true;
                
                // D-ID ë¹„ë””ì˜¤ëŠ” mutedë¡œ ì„¤ì • (Hume TTSê°€ ìŒì„± ë‹´ë‹¹)
                didVideo.muted = true;
                
                // 1. Hume TTSë¡œ ìŒì„± ìƒì„± (Promise)
                const humeTTSPromise = fetch('/tts/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                // 2. D-ID ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë¦½ì‹±í¬ ì˜ìƒ ìš”ì²­ (ë™ì‹œì—)
                const didStreamPromise = fetch('/api/did/stream/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        text: text,
                        voice_type: 'female'
                    })
                });
                
                // 3. ë‘ ìš”ì²­ ë™ì‹œ ëŒ€ê¸°
                const [humeResponse, didResponse] = await Promise.all([humeTTSPromise, didStreamPromise]);
                
                // 4. Hume TTS ì˜¤ë””ì˜¤ ì¬ìƒ
                let audioElement = null;
                if (humeResponse.ok) {
                    const audioBlob = await humeResponse.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioElement = new Audio(audioUrl);
                    console.log('âœ… Hume TTS ìŒì„± ì¤€ë¹„ ì™„ë£Œ');
                } else {
                    console.warn('âš ï¸ Hume TTS ì‹¤íŒ¨, Web Speech APIë¡œ í´ë°±');
                }
                
                // 5. D-ID ì˜ìƒ ìƒíƒœ í™•ì¸
                if (didResponse.ok) {
                    const result = await didResponse.json();
                    console.log('âœ… D-ID ë¦½ì‹±í¬ ì˜ìƒ ì‹œì‘');
                    
                    // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
                    try {
                        await didVideo.play();
                    } catch (playErr) {
                        console.warn('ë¹„ë””ì˜¤ ìë™ ì¬ìƒ ì‹¤íŒ¨:', playErr);
                    }
                } else {
                    console.warn('âš ï¸ D-ID ë¦½ì‹±í¬ ì‹¤íŒ¨');
                }
                
                // 6. ì˜¤ë””ì˜¤ì™€ ì˜ìƒ ë™ì‹œ ì¬ìƒ
                return new Promise((resolve) => {
                    if (audioElement) {
                        audioElement.onended = () => {
                            isSpeaking = false;
                            didVideo.muted = false;  // ì›ë˜ëŒ€ë¡œ ë³µì›
                            finishSpeaking();
                            resolve(true);
                        };
                        audioElement.onerror = () => {
                            console.warn('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜');
                            isSpeaking = false;
                            didVideo.muted = false;
                            finishSpeaking();
                            resolve(false);
                        };
                        audioElement.play().catch(err => {
                            console.warn('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', err);
                            // Web Speech APIë¡œ í´ë°±
                            fallbackTTS(text);
                            resolve(false);
                        });
                    } else {
                        // Hume TTS ì‹¤íŒ¨ ì‹œ Web Speech APIë¡œ í´ë°±
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'ko-KR';
                        utterance.rate = 0.9;
                        utterance.onend = () => {
                            isSpeaking = false;
                            didVideo.muted = false;
                            finishSpeaking();
                            resolve(true);
                        };
                        speechSynthesis.speak(utterance);
                    }
                });
                
            } catch (err) {
                console.error('D-ID + Hume TTS ë°œí™” ì˜¤ë¥˜:', err);
                isSpeaking = false;
                return false;
            }
        }
        
        // ========== D-ID Talks API + Hume TTS ë™ì‹œ ë°œí™” ==========
        async function didSpeakTalksWithHumeTTS(text) {
            try {
                console.log('ğŸ¬ D-ID ì˜ìƒ ìƒì„± + Hume TTS:', text.substring(0, 30) + '...');
                
                const didVideo = document.getElementById('didVideo');
                
                // D-ID ë¹„ë””ì˜¤ëŠ” mutedë¡œ ì„¤ì • (Hume TTSê°€ ìŒì„± ë‹´ë‹¹)
                didVideo.muted = true;
                
                // 1. Hume TTSë¡œ ìŒì„± ìƒì„±
                let audioElement = null;
                try {
                    const humeResponse = await fetch('/tts/speak', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text })
                    });
                    
                    if (humeResponse.ok) {
                        const audioBlob = await humeResponse.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioElement = new Audio(audioUrl);
                        console.log('âœ… Hume TTS ìŒì„± ì¤€ë¹„ ì™„ë£Œ');
                    }
                } catch (ttsErr) {
                    console.warn('Hume TTS ìš”ì²­ ì‹¤íŒ¨:', ttsErr);
                }
                
                // 2. D-ID Talk ìƒì„± ìš”ì²­
                const createResponse = await fetch('/api/did/talk/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice_type: 'female'
                    })
                });
                
                if (!createResponse.ok) {
                    console.warn('D-ID Talk ìƒì„± ì‹¤íŒ¨');
                    // Hume TTSë§Œ ì¬ìƒ
                    if (audioElement) {
                        return new Promise((resolve) => {
                            audioElement.onended = () => {
                                didVideo.muted = false;
                                finishSpeaking();
                                resolve(true);
                            };
                            audioElement.play();
                        });
                    }
                    return false;
                }
                
                const createResult = await createResponse.json();
                const talkId = createResult.talk_id;
                console.log('âœ… D-ID Talk ìƒì„±ë¨:', talkId);
                
                // 3. Talk ì™„ë£Œ ëŒ€ê¸°
                updateStatus('processing', 'AI ì•„ë°”íƒ€ ì˜ìƒ ìƒì„± ì¤‘...');
                const waitResponse = await fetch(`/api/did/talk/${talkId}/wait?timeout=60`);
                
                if (!waitResponse.ok) {
                    console.warn('D-ID Talk ëŒ€ê¸° ì‹¤íŒ¨');
                    if (audioElement) {
                        return new Promise((resolve) => {
                            audioElement.onended = () => {
                                didVideo.muted = false;
                                finishSpeaking();
                                resolve(true);
                            };
                            audioElement.play();
                        });
                    }
                    return false;
                }
                
                const waitResult = await waitResponse.json();
                
                if (waitResult.status === 'done' && waitResult.result_url) {
                    console.log('âœ… D-ID ì˜ìƒ ìƒì„± ì™„ë£Œ:', waitResult.result_url);
                    
                    // 4. ë¹„ë””ì˜¤ì™€ ì˜¤ë””ì˜¤ ë™ì‹œ ì¬ìƒ
                    didVideo.src = waitResult.result_url;
                    didVideo.classList.add('speaking');
                    
                    return new Promise((resolve) => {
                        didVideo.onloadeddata = async () => {
                            // ì˜ìƒê³¼ ìŒì„± ë™ì‹œ ì‹œì‘
                            didVideo.play();
                            if (audioElement) {
                                audioElement.play();
                            }
                        };
                        
                        // ì˜ìƒ ë˜ëŠ” ìŒì„± ì¢…ë£Œ ì‹œ ì™„ë£Œ ì²˜ë¦¬
                        const onComplete = () => {
                            didVideo.classList.remove('speaking');
                            didVideo.muted = false;
                            finishSpeaking();
                            resolve(true);
                        };
                        
                        if (audioElement) {
                            audioElement.onended = onComplete;
                        } else {
                            didVideo.onended = onComplete;
                        }
                        
                        didVideo.onerror = () => {
                            console.warn('D-ID ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜');
                            didVideo.classList.remove('speaking');
                            didVideo.muted = false;
                            if (audioElement) {
                                audioElement.onended = () => {
                                    finishSpeaking();
                                    resolve(true);
                                };
                                audioElement.play();
                            } else {
                                finishSpeaking();
                                resolve(false);
                            }
                        };
                    });
                } else {
                    console.warn('D-ID ì˜ìƒ ìƒì„± ì‹¤íŒ¨:', waitResult);
                    // Hume TTSë§Œ ì¬ìƒ
                    if (audioElement) {
                        return new Promise((resolve) => {
                            audioElement.onended = () => {
                                didVideo.muted = false;
                                finishSpeaking();
                                resolve(true);
                            };
                            audioElement.play();
                        });
                    }
                    return false;
                }
                
            } catch (err) {
                console.error('D-ID + Hume TTS ì˜¤ë¥˜:', err);
                return false;
            }
        }
        
        // ========== D-ID ì¢…ë£Œ ==========
        async function closeDIDStreaming() {
            didStreamReady = false;
            isSpeaking = false;
            
            // WebRTC PeerConnection ì¢…ë£Œ
            if (didPeerConnection) {
                didPeerConnection.close();
                didPeerConnection = null;
            }
            
            // ì„œë²„ì— ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ìš”ì²­
            if (sessionId) {
                try {
                    await fetch(`/api/did/stream/${sessionId}`, {
                        method: 'DELETE'
                    });
                } catch (err) {
                    console.warn('D-ID ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ìš”ì²­ ì‹¤íŒ¨:', err);
                }
            }
            
            // íŠ¸ë™ ì •ë¦¬
            didVideoTrack = null;
            didAudioTrack = null;
            didStreamId = null;
            didSessionId = null;
            
            // ë¹„ë””ì˜¤ ì •ë¦¬
            const didVideo = document.getElementById('didVideo');
            didVideo.pause();
            didVideo.classList.remove('speaking');
            if (didVideo.srcObject) {
                didVideo.srcObject.getTracks().forEach(track => track.stop());
                didVideo.srcObject = null;
            }
            didVideo.src = '';
            
            // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
            showDIDLoadingOverlay('ë©´ì ‘ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
            
            console.log('âœ… D-ID ì„¸ì…˜ ì¢…ë£Œ');
        }
        
        // ========== ì¹´ë©”ë¼ ì´ˆê¸°í™” ==========
        async function initCamera() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('userVideo').srcObject = mediaStream;
                console.log('âœ… ì¹´ë©”ë¼/ë§ˆì´í¬ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (err) {
                console.error('âŒ ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:', err);
                alert('ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }
        }
        
        // ========== ì‚¬ìš©ì ì˜ìƒ/ìŒì„± WebRTC ì—°ê²° (ì„œë²„ ì „ì†¡ìš©) ==========
        async function initUserWebRTC() {
            if (!mediaStream) {
                console.warn('âš ï¸ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì´ ì—†ì–´ WebRTCë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            try {
                userPeerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                userPeerConnection.onconnectionstatechange = () => {
                    console.log('ğŸ‘¤ ì‚¬ìš©ì WebRTC ì—°ê²° ìƒíƒœ:', userPeerConnection.connectionState);
                    
                    if (userPeerConnection.connectionState === 'connected') {
                        console.log('âœ… ì‚¬ìš©ì ì˜ìƒ/ìŒì„± ì„œë²„ ì „ì†¡ ì—°ê²° ì™„ë£Œ');
                    } else if (userPeerConnection.connectionState === 'failed' || 
                               userPeerConnection.connectionState === 'disconnected') {
                        console.warn('âš ï¸ ì‚¬ìš©ì WebRTC ì—°ê²° ì‹¤íŒ¨/ëŠê¹€');
                    }
                };
                
                // ICE í›„ë³´ ì´ë²¤íŠ¸ (ë¡œì»¬ ICE ìˆ˜ì§‘ìš©)
                userPeerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('ğŸ“¡ ICE í›„ë³´ ìˆ˜ì§‘ë¨');
                    }
                };
                
                // ë¯¸ë””ì–´ íŠ¸ë™ ì¶”ê°€ (ì˜ìƒ + ìŒì„±)
                mediaStream.getTracks().forEach(track => {
                    userPeerConnection.addTrack(track, mediaStream);
                    console.log(`ğŸ“¹ íŠ¸ë™ ì¶”ê°€: ${track.kind}`);
                });
                
                // SDP Offer ìƒì„±
                const offer = await userPeerConnection.createOffer();
                await userPeerConnection.setLocalDescription(offer);
                
                // ì„œë²„ì— Offer ì „ì†¡
                const response = await fetch('/offer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sdp: offer.sdp,
                        type: offer.type
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ì„œë²„ WebRTC Offer ì²˜ë¦¬ ì‹¤íŒ¨');
                }
                
                const answer = await response.json();
                
                // ì„œë²„ ì‘ë‹µ ì„¸ì…˜ ID ì €ì¥
                if (answer.session_id && !sessionId) {
                    sessionId = answer.session_id;
                }
                
                // SDP Answer ì ìš©
                await userPeerConnection.setRemoteDescription(
                    new RTCSessionDescription({ sdp: answer.sdp, type: answer.type })
                );
                
                console.log('âœ… ì‚¬ìš©ì ì˜ìƒ WebRTC ì—°ê²° ì™„ë£Œ. ì„¸ì…˜:', sessionId);
                
                // WebSocket ì—°ê²° ì‹œì‘ (STT ê²°ê³¼ ìˆ˜ì‹ ìš©)
                await initInterviewWebSocket();
                
                return true;
                
            } catch (err) {
                console.error('âŒ ì‚¬ìš©ì WebRTC ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
                return false;
            }
        }
        
        // ========== WebSocket ì—°ê²° (ì„œë²„ STT ê²°ê³¼ ìˆ˜ì‹ ) ==========
        async function initInterviewWebSocket() {
            if (!sessionId) {
                console.warn('âš ï¸ ì„¸ì…˜ IDê°€ ì—†ì–´ WebSocketì„ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/interview/${sessionId}`;
                
                userWebSocket = new WebSocket(wsUrl);
                
                userWebSocket.onopen = () => {
                    console.log('âœ… ë©´ì ‘ WebSocket ì—°ê²°ë¨');
                };
                
                userWebSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.warn('WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
                    }
                };
                
                userWebSocket.onerror = (error) => {
                    console.error('âŒ WebSocket ì˜¤ë¥˜:', error);
                };
                
                userWebSocket.onclose = () => {
                    console.log('ğŸ”Œ ë©´ì ‘ WebSocket ì—°ê²° ì¢…ë£Œ');
                    serverSTTEnabled = false;
                };
                
                // ì—°ê²° ëŒ€ê¸°
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ')), 5000);
                    userWebSocket.addEventListener('open', () => {
                        clearTimeout(timeout);
                        resolve();
                    }, { once: true });
                    userWebSocket.addEventListener('error', () => {
                        clearTimeout(timeout);
                        reject(new Error('WebSocket ì—°ê²° ì‹¤íŒ¨'));
                    }, { once: true });
                });
                
                return true;
                
            } catch (err) {
                console.error('âŒ WebSocket ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
                return false;
            }
        }
        
        // ========== WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ ==========
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connected':
                    serverSTTEnabled = data.stt_available;
                    console.log(`âœ… ì„œë²„ STT (Deepgram) ${serverSTTEnabled ? 'í™œì„±í™”ë¨' : 'ë¹„í™œì„±í™”ë¨'}`);
                    
                    // Deepgram ìš°ì„  ì‚¬ìš© ì„¤ì •
                    if (PREFER_SERVER_STT && serverSTTEnabled) {
                        useServerSTT = true;
                        // Web Speech API ì¤‘ì§€ (Deepgram ì‚¬ìš©)
                        if (recognition && isListening) {
                            try {
                                recognition.stop();
                                console.log('ğŸ¤ Deepgram(ì„œë²„ STT) ìš°ì„  ì‚¬ìš© - Web Speech API ì¤‘ì§€');
                            } catch (e) {}
                        }
                    } else if (!serverSTTEnabled) {
                        // Deepgram ë¶ˆê°€ ì‹œ Web Speech APIë¡œ í´ë°±
                        useServerSTT = false;
                        console.log('ğŸ¤ Deepgram ë¶ˆê°€ - Web Speech APIë¡œ í´ë°±');
                        if (recognition && isInterviewActive && !isMicMuted && !isListening) {
                            try {
                                recognition.start();
                            } catch (e) {}
                        }
                    }
                    break;
                    
                case 'stt_result':
                    // Deepgramì—ì„œ ë°›ì€ STT ê²°ê³¼ í‘œì‹œ (í•­ìƒ ìš°ì„  ì²˜ë¦¬)
                    if (serverSTTEnabled) {
                        const speechTextEl = document.getElementById('speechText');
                        speechTextEl.classList.remove('placeholder');
                        speechTextEl.textContent = data.transcript || '...';
                        
                        // VAD ì‹ í˜¸ ì „ì†¡
                        if (data.transcript) {
                            sendVADSignal(true, 0.7);
                            answerLengthSoFar = speechBuffer.length + data.transcript.length;
                        }
                        
                        // ìµœì¢… ê²°ê³¼ë©´ ë²„í¼ì— ì¶”ê°€
                        if (data.is_final && data.transcript) {
                            speechBuffer += data.transcript + ' ';
                            resetSilenceTimer();
                        }
                    }
                    break;
                    
                case 'intervention':
                    // ì„œë²„ì—ì„œ ë³´ë‚¸ ê°œì… ë©”ì‹œì§€ ì²˜ë¦¬
                    handleInterventionFromServer(data);
                    break;
                    
                case 'pong':
                    // í•‘í ì‘ë‹µ
                    break;
                    
                default:
                    console.log('ğŸ“¨ WebSocket ë©”ì‹œì§€:', data);
            }
        }
        
        // ========== ì„œë²„ ê°œì… ë©”ì‹œì§€ ì²˜ë¦¬ ==========
        function handleInterventionFromServer(data) {
            console.log('ğŸš¨ ì„œë²„ ê°œì…:', data.message);
            // ê¸°ì¡´ showInterventionMessage í•¨ìˆ˜ í˜¸ì¶œ
            if (typeof showInterventionMessage === 'function') {
                showInterventionMessage(data.message, data.intervention_type || 'info');
            }
        }
        
        // ========== ì‚¬ìš©ì WebRTC ì—°ê²° ì¢…ë£Œ ==========
        async function closeUserWebRTC() {
            // WebSocket ì¢…ë£Œ
            if (userWebSocket) {
                try {
                    userWebSocket.close();
                } catch (e) {}
                userWebSocket = null;
            }
            
            // PeerConnection ì¢…ë£Œ
            if (userPeerConnection) {
                try {
                    userPeerConnection.close();
                } catch (e) {}
                userPeerConnection = null;
            }
            
            serverSTTEnabled = false;
            console.log('âœ… ì‚¬ìš©ì WebRTC ì—°ê²° ì¢…ë£Œ');
        }
        
        // ========== ìŒì„± ì¸ì‹ ì´ˆê¸°í™” (Web Speech API) ==========
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('âš ï¸ ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onstart = () => {
                isListening = true;
                document.getElementById('micIndicator').classList.add('listening');
                updateStatus('listening', 'ë“£ëŠ” ì¤‘...');
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // í™”ë©´ì— í‘œì‹œ
                const speechTextEl = document.getElementById('speechText');
                speechTextEl.classList.remove('placeholder');
                speechTextEl.textContent = finalTranscript || interimTranscript || '...';
                
                // VAD ì‹ í˜¸ ì „ì†¡ (ì‚¬ìš©ìê°€ ë§í•˜ê³  ìˆìŒ)
                if (interimTranscript || finalTranscript) {
                    sendVADSignal(true, 0.7);
                    answerLengthSoFar = speechBuffer.length + (finalTranscript || interimTranscript).length;
                }
                
                // ìµœì¢… ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë²„í¼ì— ì¶”ê°€
                if (finalTranscript) {
                    speechBuffer += finalTranscript + ' ';
                    resetSilenceTimer();
                }
            };
            
            recognition.onerror = (event) => {
                console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                if (event.error === 'not-allowed') {
                    alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }
            };
            
            recognition.onend = () => {
                isListening = false;
                document.getElementById('micIndicator').classList.remove('listening');
                
                // ë©´ì ‘ ì¤‘ì´ë©´ ë‹¤ì‹œ ì‹œì‘
                if (isInterviewActive && !isMicMuted) {
                    setTimeout(() => {
                        if (isInterviewActive && !isMicMuted) {
                            recognition.start();
                        }
                    }, 100);
                }
            };
            
            console.log('âœ… ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì™„ë£Œ');
        }
        
        // ========== ì¹¨ë¬µ íƒ€ì´ë¨¸ (ë‹µë³€ ì™„ë£Œ ê°ì§€) ==========
        function resetSilenceTimer() {
            if (silenceTimer) clearTimeout(silenceTimer);
            
            // 3ì´ˆê°„ ë§ì´ ì—†ìœ¼ë©´ ë‹µë³€ ì™„ë£Œë¡œ ê°„ì£¼
            silenceTimer = setTimeout(async () => {
                if (speechBuffer.trim().length > 10 && isInterviewActive) {
                    // VAD ì‹ í˜¸: ì‚¬ìš©ìê°€ ë§ì„ ë©ˆì¶¤
                    sendVADSignal(false, 0);
                    
                    // ì •ìƒ í„´ ì¢…ë£Œ ì²˜ë¦¬
                    const answer = speechBuffer.trim();
                    await endUserTurn(answer);
                    
                    processUserAnswer(answer);
                    speechBuffer = '';
                }
            }, 3000);
        }
        
        // ========== ë©´ì ‘ ì‹œì‘ ==========
        async function startInterview() {
            // ë¡œê·¸ì¸ ìƒíƒœ ì¬í™•ì¸
            currentUser = checkLoginStatus();
            if (!currentUser) {
                alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/';
                return;
            }
            
            // ì´ë ¥ì„œ ì—…ë¡œë“œ ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('resumeModal').classList.add('active');
        }
        
        async function skipResume() {
            document.getElementById('resumeModal').classList.remove('active');
            await beginInterview();
        }
        
        async function beginInterview() {
            // ë¡œê·¸ì¸ ìƒíƒœ ì¬í™•ì¸
            currentUser = checkLoginStatus();
            if (!currentUser) {
                alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/';
                return;
            }
            
            try {
                // ê°œì… ì„¤ì • ë¡œë“œ
                await loadInterventionSettings();
                
                // ì„¸ì…˜ ìƒì„± (ì‚¬ìš©ì ì •ë³´ í¬í•¨)
                const response = await fetch('/api/session', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_email: currentUser.email,
                        user_id: currentUser.user_id || currentUser.id
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const data = await response.json();
                sessionId = data.session_id;
                
                isInterviewActive = true;
                currentQuestionIndex = 0;
                
                // D-ID ìŠ¤íŠ¸ë¦¬ë° ì´ˆê¸°í™” ì‹œë„
                if (didAvailable) {
                    updateStatus('processing');
                    const didInitialized = await initDIDStreaming();
                    if (didInitialized) {
                        console.log('âœ… D-ID ìŠ¤íŠ¸ë¦¬ë° ì¤€ë¹„ ì™„ë£Œ');
                    }
                }
                
                // ì‚¬ìš©ì ì˜ìƒ/ìŒì„± WebRTC ì—°ê²° (ê°ì •ë¶„ì„ + ì„œë²„ STTìš©)
                const userWebRTCInitialized = await initUserWebRTC();
                if (userWebRTCInitialized) {
                    console.log('âœ… ì‚¬ìš©ì ì˜ìƒ/ìŒì„± ì„œë²„ ì „ì†¡ ì¤€ë¹„ ì™„ë£Œ');
                } else {
                    console.warn('âš ï¸ ì‚¬ìš©ì WebRTC ì—°ê²° ì‹¤íŒ¨ - í´ë¼ì´ì–¸íŠ¸ STT ì‚¬ìš©');
                    useServerSTT = false;
                }
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('endBtn').style.display = 'inline-block';
                // ì‹¤ì‹œê°„ í‰ê°€ íŒ¨ë„ ë¹„í™œì„±í™”ë¨ - ë©´ì ‘ ì¢…ë£Œ í›„ ë¦¬í¬íŠ¸ì—ì„œ í™•ì¸
                
                updateStatus('ready', 'ë©´ì ‘ ì§„í–‰ ì¤‘');
                
                // ì²« ë²ˆì§¸ ì§ˆë¬¸ ìš”ì²­
                await getNextQuestion();
                
                // ìŒì„± ì¸ì‹ ì‹œì‘
                // Deepgram(ì„œë²„ STT) ìš°ì„  ì‚¬ìš© - WebRTC ì—°ê²° ì„±ê³µ ì‹œ ìë™ í™œì„±í™”ë¨
                // Web Speech APIëŠ” Deepgram ë¶ˆê°€ ì‹œì—ë§Œ í´ë°±ìœ¼ë¡œ ì‚¬ìš©
                if (serverSTTEnabled) {
                    console.log('ğŸ¤ Deepgram(ì„œë²„ STT) ìŒì„± ì¸ì‹ í™œì„±í™”ë¨');
                } else if (!serverSTTEnabled && recognition && !isMicMuted) {
                    // Deepgram ë¶ˆê°€ ì‹œ Web Speech API í´ë°±
                    recognition.start();
                    console.log('ğŸ¤ Deepgram ë¶ˆê°€ - Web Speech API ìŒì„± ì¸ì‹ìœ¼ë¡œ í´ë°±');
                }
                
            } catch (err) {
                console.error('ë©´ì ‘ ì‹œì‘ ì‹¤íŒ¨:', err);
                alert('ë©´ì ‘ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ========== ë‹¤ìŒ ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸° ==========
        async function getNextQuestion() {
            try {
                updateStatus('processing', 'AI ì§ˆë¬¸ ìƒì„± ì¤‘...');
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: currentQuestionIndex === 0 ? '[START]' : '[NEXT]'
                    })
                });
                
                const data = await response.json();
                currentQuestion = data.response;
                currentQuestionIndex++;
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('currentQuestion').textContent = currentQuestion;
                document.getElementById('questionCounter').textContent = `ì§ˆë¬¸ ${currentQuestionIndex}/9`;
                updateProgress();
                
                // TTSë¡œ ì§ˆë¬¸ ì½ê¸°
                await speakQuestion(currentQuestion);
                
            } catch (err) {
                console.error('ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
            }
        }
        
        // ========== TTSë¡œ ì§ˆë¬¸ ì½ê¸° ==========
        async function speakQuestion(text) {
            updateStatus('speaking', 'AI ë©´ì ‘ê´€ ë°œì–¸ ì¤‘...');
            
            // ìŒì„± ë¹„ì£¼ì–¼ë¼ì´ì € í™œì„±í™”
            document.getElementById('voiceVisualizer').classList.add('active');
            document.getElementById('didVideo').classList.add('speaking');
            
            // ìŒì„± ì¸ì‹ ì¼ì‹œ ì¤‘ì§€
            if (recognition && isListening) {
                recognition.stop();
            }
            
            try {
                // D-IDê°€ í™œì„±í™”ëœ ê²½ìš° D-ID Talks API ì‚¬ìš©
                if (didAvailable && didStreamReady) {
                    console.log('ğŸ¬ D-ID ì•„ë°”íƒ€ë¡œ ë°œì–¸...');
                    const success = await didSpeak(text);
                    if (success) return;  // D-ID ì„±ê³µ ì‹œ ë¦¬í„´
                    // D-ID ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ TTSë¡œ í´ë°±
                    console.log('âš ï¸ D-ID ì‹¤íŒ¨, TTSë¡œ í´ë°±');
                }
                
                // TTS API í˜¸ì¶œ ì‹œë„
                const response = await fetch('/tts/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        finishSpeaking();
                    };
                    
                    await audio.play();
                } else {
                    // TTS ì‹¤íŒ¨ ì‹œ Web Speech API ì‚¬ìš©
                    fallbackTTS(text);
                }
            } catch (err) {
                console.warn('TTS API ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', err);
                fallbackTTS(text);
            }
        }
        
        function fallbackTTS(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 0.9;
            
            utterance.onend = () => {
                finishSpeaking();
            };
            
            speechSynthesis.speak(utterance);
        }
        
        function finishSpeaking() {
            document.getElementById('voiceVisualizer').classList.remove('active');
            document.getElementById('didVideo').classList.remove('speaking');
            updateStatus('listening', 'ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...');
            
            // ìŒì„± ì¸ì‹ ì¬ì‹œì‘ ë° ì‚¬ìš©ì í„´ ì‹œì‘
            if (recognition && !isMicMuted && isInterviewActive) {
                setTimeout(() => {
                    recognition.start();
                    startUserTurn(); // ê°œì… ì‹œìŠ¤í…œ: ì‚¬ìš©ì í„´ ì‹œì‘
                }, 500);
            }
        }
        
        // ========== ì‹¤ì‹œê°„ ê°œì… ì‹œìŠ¤í…œ ==========
        
        // ì‚¬ìš©ì í„´ ì‹œì‘ (ì§ˆë¬¸ í›„ ë‹µë³€ ì‹œì‘ ì‹œì )
        async function startUserTurn() {
            if (!interventionEnabled || !sessionId) return;
            
            currentTurnStartTime = Date.now();
            answerLengthSoFar = 0;
            hasReceivedSoftWarning = false;
            
            try {
                const response = await fetch('/api/intervention/start-turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        question: currentQuestion
                    })
                });
                
                if (response.ok) {
                    console.log('âœ… ì‚¬ìš©ì í„´ ì‹œì‘ë¨');
                    // ê°œì… ì²´í¬ ì¸í„°ë²Œ ì‹œì‘ (2ì´ˆë§ˆë‹¤)
                    startInterventionChecking();
                }
            } catch (err) {
                console.warn('í„´ ì‹œì‘ API ì˜¤ë¥˜:', err);
            }
        }
        
        // VAD ì‹ í˜¸ ì „ì†¡ (ìŒì„± í™œë™ ê°ì§€ ì‹œ)
        async function sendVADSignal(isSpeaking, amplitude = 0.5) {
            if (!interventionEnabled || !sessionId) return;
            
            lastVADSignalTime = Date.now();
            
            try {
                await fetch('/api/intervention/vad-signal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        is_speaking: isSpeaking,
                        amplitude: amplitude
                    })
                });
            } catch (err) {
                // VAD ì‹ í˜¸ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
            }
        }
        
        // ê°œì… ì²´í¬ ì‹œì‘ (ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œ)
        function startInterventionChecking() {
            stopInterventionChecking(); // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            
            interventionCheckInterval = setInterval(async () => {
                if (!isInterviewActive || isSpeaking) return;
                await checkIntervention();
            }, 2000); // 2ì´ˆë§ˆë‹¤ ì²´í¬
        }
        
        // ê°œì… ì²´í¬ ì¤‘ì§€
        function stopInterventionChecking() {
            if (interventionCheckInterval) {
                clearInterval(interventionCheckInterval);
                interventionCheckInterval = null;
            }
            hideAnswerTimer(); // íƒ€ì´ë¨¸ ìˆ¨ê¸°ê¸°
        }
        
        // ê°œì… í•„ìš” ì—¬ë¶€ ì²´í¬
        async function checkIntervention() {
            if (!interventionEnabled || !sessionId || !currentTurnStartTime) return;
            
            const elapsedTime = (Date.now() - currentTurnStartTime) / 1000;
            
            // ë‹µë³€ ì‹œê°„ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
            updateAnswerTimer(elapsedTime);
            
            try {
                const response = await fetch('/api/intervention/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        current_answer: speechBuffer,
                        elapsed_time: elapsedTime
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.should_intervene) {
                        handleIntervention(result);
                    }
                }
            } catch (err) {
                console.warn('ê°œì… ì²´í¬ ì˜¤ë¥˜:', err);
            }
        }
        
        // ë‹µë³€ ì‹œê°„ íƒ€ì´ë¨¸ UI ì—…ë°ì´íŠ¸
        function updateAnswerTimer(elapsedTime) {
            const timerEl = document.getElementById('answerTimer');
            const timerTextEl = document.getElementById('answerTimerText');
            
            if (!timerEl || !timerTextEl) return;
            
            const seconds = Math.floor(elapsedTime);
            const maxTime = interventionSettings.max_answer_time || 120;
            const warningTime = interventionSettings.soft_warning_time || 90;
            
            timerTextEl.textContent = `ë‹µë³€ ì‹œê°„: ${seconds}ì´ˆ / ${maxTime}ì´ˆ`;
            timerEl.style.display = 'block';
            
            // ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
            timerEl.classList.remove('warning', 'danger');
            if (seconds >= maxTime - 10) {
                timerEl.classList.add('danger');
            } else if (seconds >= warningTime) {
                timerEl.classList.add('warning');
            }
        }
        
        // ë‹µë³€ ì‹œê°„ íƒ€ì´ë¨¸ ìˆ¨ê¸°ê¸°
        function hideAnswerTimer() {
            const timerEl = document.getElementById('answerTimer');
            if (timerEl) {
                timerEl.style.display = 'none';
                timerEl.classList.remove('warning', 'danger');
            }
        }
        
        // ê°œì… ì²˜ë¦¬
        async function handleIntervention(interventionResult) {
            const { intervention_type, message, details } = interventionResult;
            
            console.log(`ğŸš¨ ê°œì… ë°œìƒ: ${intervention_type}`);
            
            // ê°œì… UI í‘œì‹œ
            showInterventionMessage(intervention_type, message);
            
            if (intervention_type === 'soft_warning') {
                // ë¶€ë“œëŸ¬ìš´ ê²½ê³ : TTSë¡œ ì•ˆë‚´ (ìŒì„± ì¸ì‹ ê³„ì†)
                hasReceivedSoftWarning = true;
                await speakInterventionMessage(message);
                
            } else if (intervention_type === 'hard_limit' || intervention_type === 'off_topic') {
                // ê°•ì œ ì¢…ë£Œ: í˜„ì¬ ë‹µë³€ ì œì¶œí•˜ê³  ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ
                stopInterventionChecking();
                
                if (recognition && isListening) {
                    recognition.stop();
                }
                
                // í˜„ì¬ê¹Œì§€ì˜ ë‹µë³€ ì²˜ë¦¬
                if (speechBuffer.trim().length > 10) {
                    await processUserAnswerWithIntervention(speechBuffer.trim(), intervention_type);
                } else {
                    // ë‹µë³€ì´ ê±°ì˜ ì—†ìœ¼ë©´ TTS ì•ˆë‚´ í›„ ë‹¤ìŒ ì§ˆë¬¸
                    await speakInterventionMessage(message);
                    await getNextQuestion();
                }
                
                speechBuffer = '';
            }
        }
        
        // ê°œì… ë©”ì‹œì§€ UI í‘œì‹œ
        function showInterventionMessage(type, message) {
            // ê¸°ì¡´ ê°œì… ë©”ì‹œì§€ ì œê±°
            const existingMsg = document.getElementById('interventionMessage');
            if (existingMsg) existingMsg.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.id = 'interventionMessage';
            msgDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: 500;
                z-index: 10000;
                animation: slideDown 0.3s ease;
                max-width: 80%;
                text-align: center;
            `;
            
            // íƒ€ì…ë³„ ìŠ¤íƒ€ì¼
            if (type === 'soft_warning') {
                msgDiv.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                msgDiv.style.color = 'white';
                msgDiv.innerHTML = `âš¡ ${message}`;
            } else if (type === 'hard_limit') {
                msgDiv.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                msgDiv.style.color = 'white';
                msgDiv.innerHTML = `â° ${message}`;
            } else if (type === 'off_topic') {
                msgDiv.style.background = 'linear-gradient(135deg, #9b59b6, #8e44ad)';
                msgDiv.style.color = 'white';
                msgDiv.innerHTML = `ğŸ”€ ${message}`;
            }
            
            document.body.appendChild(msgDiv);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (msgDiv.parentNode) {
                    msgDiv.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => msgDiv.remove(), 300);
                }
            }, 5000);
        }
        
        // ê°œì… ë©”ì‹œì§€ TTS ë°œí™”
        async function speakInterventionMessage(message) {
            // ê°„ë‹¨í•œ TTS (ë¹ ë¥¸ ë°œí™”)
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.0;
            
            return new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = resolve;
                speechSynthesis.speak(utterance);
            });
        }
        
        // ê°œì…ìœ¼ë¡œ ì¸í•œ ë‹µë³€ ì²˜ë¦¬
        async function processUserAnswerWithIntervention(answer, interventionType) {
            stopInterventionChecking();
            
            try {
                // í„´ ì¢…ë£Œ API í˜¸ì¶œ
                await fetch('/api/intervention/end-turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        final_answer: answer,
                        was_intervened: true,
                        intervention_type: interventionType
                    })
                });
                
                // ê¸°ì¡´ ë‹µë³€ ì²˜ë¦¬ ë¡œì§ í˜¸ì¶œ
                await processUserAnswer(answer);
                
            } catch (err) {
                console.warn('ê°œì… ë‹µë³€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                await processUserAnswer(answer);
            }
        }
        
        // ì‚¬ìš©ì í„´ ì¢…ë£Œ (ì •ìƒ ë‹µë³€ ì™„ë£Œ ì‹œ)
        async function endUserTurn(answer) {
            stopInterventionChecking();
            
            if (!interventionEnabled || !sessionId) return;
            
            try {
                await fetch('/api/intervention/end-turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        final_answer: answer,
                        was_intervened: false
                    })
                });
            } catch (err) {
                console.warn('í„´ ì¢…ë£Œ API ì˜¤ë¥˜:', err);
            }
            
            currentTurnStartTime = null;
        }
        
        // ê°œì… ì„¤ì • ë¡œë“œ
        async function loadInterventionSettings() {
            try {
                const response = await fetch('/api/intervention/settings');
                if (response.ok) {
                    interventionSettings = await response.json();
                    console.log('âœ… ê°œì… ì„¤ì • ë¡œë“œë¨:', interventionSettings);
                }
            } catch (err) {
                console.warn('ê°œì… ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }
        
        // ========== ì‚¬ìš©ì ë‹µë³€ ì²˜ë¦¬ ==========
        async function processUserAnswer(answer) {
            if (!isInterviewActive || answer.length < 5) return;
            
            updateStatus('processing', 'ë‹µë³€ ë¶„ì„ ì¤‘...');
            
            // ìŒì„± ì¸ì‹ ì¼ì‹œ ì¤‘ì§€
            if (recognition && isListening) {
                recognition.stop();
            }
            
            try {
                // ë°±ê·¸ë¼ìš´ë“œì—ì„œ LLM í‰ê°€
                evaluateAnswer(currentQuestion, answer);
                
                // ë©´ì ‘ ì¢…ë£Œ ì²´í¬
                if (currentQuestionIndex >= 9) {
                    await endInterview();
                    return;
                }
                
                // ë‹¤ìŒ ì§ˆë¬¸
                await getNextQuestion();
                
            } catch (err) {
                console.error('ë‹µë³€ ì²˜ë¦¬ ì‹¤íŒ¨:', err);
            }
        }
        
        // ========== LLM í‰ê°€ (ë°±ê·¸ë¼ìš´ë“œ) ==========
        async function evaluateAnswer(question, answer) {
            try {
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        question: question,
                        answer: answer
                    })
                });
                
                const data = await response.json();
                
                if (data.scores) {
                    updateEvaluationDisplay(data);
                }
                
            } catch (err) {
                console.error('í‰ê°€ ì‹¤íŒ¨:', err);
            }
        }
        
        // ========== í‰ê°€ ì ìˆ˜ UI ì—…ë°ì´íŠ¸ ==========
        function updateEvaluationDisplay(evaluation) {
            const scores = evaluation.scores || {};
            
            const scoreMap = {
                'specificity': 'êµ¬ì²´ì„±',
                'logic': 'ë…¼ë¦¬ì„±',
                'technical': 'ê¸°ìˆ ì´í•´',
                'star': 'STARê¸°ë²•',
                'communication': 'ì „ë‹¬ë ¥'
            };
            
            for (const [key, label] of Object.entries(scoreMap)) {
                const score = scores[key] || 0;
                const percentage = (score / 5) * 100;
                
                const fillEl = document.getElementById(`score-${key}`);
                const valEl = document.getElementById(`val-${key}`);
                
                if (fillEl) fillEl.style.width = `${percentage}%`;
                if (valEl) valEl.textContent = score;
            }
        }
        
        // ========== ê°ì • ë¶„ì„ ì—…ë°ì´íŠ¸ ==========
        async function updateEmotions() {
            if (!isInterviewActive) return;
            
            try {
                const response = await fetch('/emotion');
                const data = await response.json();
                
                if (data.probabilities) {
                    const emotions = data.probabilities;
                    document.getElementById('emo-happy').textContent = `${Math.round((emotions.happy || 0) * 100)}%`;
                    document.getElementById('emo-neutral').textContent = `${Math.round((emotions.neutral || 0) * 100)}%`;
                    document.getElementById('emo-surprise').textContent = `${Math.round((emotions.surprise || 0) * 100)}%`;
                    document.getElementById('emo-fear').textContent = `${Math.round((emotions.fear || 0) * 100)}%`;
                }
            } catch (err) {
                // ê°ì • ë¶„ì„ ë¹„í™œì„±í™” ìƒíƒœ
            }
        }
        
        // 1ì´ˆë§ˆë‹¤ ê°ì • ì—…ë°ì´íŠ¸
        setInterval(updateEmotions, 1000);
        
        // ========== ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ ==========
        function updateProgress() {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, index) => {
                step.classList.remove('completed', 'current');
                if (index < currentQuestionIndex - 1) {
                    step.classList.add('completed');
                } else if (index === currentQuestionIndex - 1) {
                    step.classList.add('current');
                }
            });
        }
        
        // ========== ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸ ==========
        function updateStatus(status, text) {
            const badge = document.getElementById('statusBadge');
            badge.className = 'status-badge ' + status;
            badge.textContent = text;
        }
        
        // ========== ë§ˆì´í¬ í† ê¸€ ==========
        function toggleMic() {
            isMicMuted = !isMicMuted;
            const btn = document.getElementById('micBtn');
            
            if (isMicMuted) {
                btn.classList.add('muted');
                btn.textContent = 'ğŸ”‡';
                if (recognition && isListening) {
                    recognition.stop();
                }
            } else {
                btn.classList.remove('muted');
                btn.textContent = 'ğŸ¤';
                if (recognition && isInterviewActive) {
                    recognition.start();
                }
            }
            
            // ì˜¤ë””ì˜¤ íŠ¸ë™ ìŒì†Œê±°
            if (mediaStream) {
                mediaStream.getAudioTracks().forEach(track => {
                    track.enabled = !isMicMuted;
                });
            }
        }
        
        // ========== ì¹´ë©”ë¼ í† ê¸€ ==========
        function toggleCamera() {
            isCameraOff = !isCameraOff;
            const btn = document.getElementById('cameraBtn');
            
            if (isCameraOff) {
                btn.classList.add('off');
                btn.textContent = 'ğŸ“·';
            } else {
                btn.classList.remove('off');
                btn.textContent = 'ğŸ“¹';
            }
            
            // ë¹„ë””ì˜¤ íŠ¸ë™ ë„ê¸°
            if (mediaStream) {
                mediaStream.getVideoTracks().forEach(track => {
                    track.enabled = !isCameraOff;
                });
            }
        }
        
        // ========== ë©´ì ‘ ì¢…ë£Œ ==========
        async function endInterview() {
            isInterviewActive = false;
            
            // ê°œì… ì‹œìŠ¤í…œ ì •ë¦¬
            stopInterventionChecking();
            
            if (recognition && isListening) {
                recognition.stop();
            }
            
            // ì‚¬ìš©ì ì˜ìƒ WebRTC ì—°ê²° ì¢…ë£Œ
            await closeUserWebRTC();
            
            // D-ID ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ
            await closeDIDStreaming();
            
            updateStatus('ready', 'ë©´ì ‘ ì¢…ë£Œ');
            
            // UI ì´ˆê¸°í™”
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('endBtn').style.display = 'none';
            
            // ì½”ë”© í…ŒìŠ¤íŠ¸ë¡œ ìë™ ì „í™˜
            showCodingTestTransition();
        }
        
        // ========== ì½”ë”© í…ŒìŠ¤íŠ¸ ì „í™˜ í™”ë©´ ==========
        function showCodingTestTransition() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'codingTestTransitionModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px; text-align: center;">
                    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ‰</div>
                    <h2 style="margin-bottom: 15px;">í™”ìƒ ë©´ì ‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                    <p style="color: #8892b0; margin-bottom: 30px; line-height: 1.6;">
                        ë‹¤ìŒ ë‹¨ê³„ë¡œ <strong style="color: #00d9ff;">ì½”ë”© í…ŒìŠ¤íŠ¸</strong>ê°€ ì§„í–‰ë©ë‹ˆë‹¤.<br>
                        ì‹¤ì œ ì½”ë”© ë¬¸ì œë¥¼ í’€ê³  AIê°€ ì½”ë“œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
                    </p>
                    <div style="background: rgba(0,217,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="font-size: 24px;">ğŸ’»</div>
                                <div style="font-size: 12px; color: #8892b0; margin-top: 5px;">ì½”ë“œ ì‘ì„±</div>
                            </div>
                            <div>
                                <div style="font-size: 24px;">âš¡</div>
                                <div style="font-size: 12px; color: #8892b0; margin-top: 5px;">ì‹¤í–‰ í…ŒìŠ¤íŠ¸</div>
                            </div>
                            <div>
                                <div style="font-size: 24px;">ğŸ¤–</div>
                                <div style="font-size: 12px; color: #8892b0; margin-top: 5px;">AI ë¶„ì„</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <span style="color: #ffc107;">â±ï¸</span>
                        <span style="color: #8892b0; font-size: 14px;"> ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤: </span>
                        <span id="countdownTimer" style="color: #00ff88; font-weight: bold; font-size: 18px;">5</span>
                        <span style="color: #8892b0; font-size: 14px;">ì´ˆ</span>
                    </div>
                    <div class="modal-buttons" style="justify-content: center;">
                        <button class="btn btn-primary" onclick="startCodingTest()" style="padding: 15px 40px; font-size: 16px;">
                            ğŸ’» ì§€ê¸ˆ ì‹œì‘í•˜ê¸°
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="skipCodingTest()">
                            ê±´ë„ˆë›°ê¸°
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
            let countdown = 5;
            const timerEl = document.getElementById('countdownTimer');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (timerEl) timerEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    startCodingTest();
                }
            }, 1000);
            
            // ëª¨ë‹¬ì— ì¸í„°ë²Œ ì €ì¥ (ì·¨ì†Œìš©)
            modal.dataset.countdownInterval = countdownInterval;
        }
        
        // ========== ì½”ë”© í…ŒìŠ¤íŠ¸ ì‹œì‘ ==========
        function startCodingTest() {
            // ì „í™˜ ëª¨ë‹¬ ì œê±°
            const transitionModal = document.getElementById('codingTestTransitionModal');
            if (transitionModal) {
                const interval = transitionModal.dataset.countdownInterval;
                if (interval) clearInterval(parseInt(interval));
                transitionModal.remove();
            }
            
            // ì½”ë”© í…ŒìŠ¤íŠ¸ í™”ë©´ í‘œì‹œ
            showCodingTestScreen();
        }
        
        // ========== ì½”ë”© í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° ==========
        function skipCodingTest() {
            // ì „í™˜ ëª¨ë‹¬ ì œê±°
            const transitionModal = document.getElementById('codingTestTransitionModal');
            if (transitionModal) {
                const interval = transitionModal.dataset.countdownInterval;
                if (interval) clearInterval(parseInt(interval));
                transitionModal.remove();
            }
            
            // ë°”ë¡œ ìµœì¢… ë¦¬í¬íŠ¸ í‘œì‹œ
            showFinalReport();
        }
        
        // ========== ì½”ë”© í…ŒìŠ¤íŠ¸ í™”ë©´ ==========
        async function showCodingTestScreen() {
            // ë©”ì¸ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            document.querySelector('.main-layout').style.display = 'none';
            document.querySelector('.header h1').textContent = 'ğŸ’» ì½”ë”© í…ŒìŠ¤íŠ¸';
            
            // ì½”ë”© í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
            const codingContainer = document.createElement('div');
            codingContainer.id = 'codingTestContainer';
            codingContainer.innerHTML = `
                <style>
                    #codingTestContainer {
                        display: flex;
                        gap: 20px;
                        height: calc(100vh - 120px);
                    }
                    .problem-panel {
                        width: 40%;
                        background: rgba(255,255,255,0.05);
                        border: 1px solid rgba(255,255,255,0.1);
                        border-radius: 16px;
                        padding: 20px;
                        overflow-y: auto;
                    }
                    .code-panel {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                    }
                    .editor-wrapper {
                        flex: 1;
                        background: #1e1e1e;
                        border-radius: 12px;
                        overflow: hidden;
                        border: 1px solid rgba(255,255,255,0.1);
                    }
                    .editor-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px 15px;
                        background: #2d2d30;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                    }
                    .editor-header select {
                        background: #3c3c3c;
                        color: #fff;
                        border: 1px solid rgba(255,255,255,0.2);
                        padding: 6px 12px;
                        border-radius: 6px;
                    }
                    #codeEditor {
                        width: 100%;
                        height: calc(100% - 50px);
                        background: #1e1e1e;
                        color: #d4d4d4;
                        font-family: 'Consolas', 'Monaco', monospace;
                        font-size: 14px;
                        padding: 15px;
                        border: none;
                        resize: none;
                        outline: none;
                    }
                    .output-panel {
                        height: 180px;
                        background: rgba(255,255,255,0.05);
                        border: 1px solid rgba(255,255,255,0.1);
                        border-radius: 12px;
                        overflow: hidden;
                    }
                    .output-header {
                        padding: 10px 15px;
                        background: rgba(255,255,255,0.05);
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .output-content {
                        padding: 15px;
                        font-family: monospace;
                        font-size: 13px;
                        height: calc(100% - 45px);
                        overflow-y: auto;
                    }
                    .test-result {
                        display: flex;
                        align-items: center;
                        padding: 8px 12px;
                        margin-bottom: 6px;
                        background: rgba(0,0,0,0.3);
                        border-radius: 6px;
                        border-left: 3px solid;
                    }
                    .test-result.passed { border-left-color: #4caf50; }
                    .test-result.failed { border-left-color: #f44336; }
                    .problem-title { font-size: 20px; font-weight: 700; margin-bottom: 15px; color: #00d9ff; }
                    .difficulty-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 10px; }
                    .difficulty-easy { background: rgba(76,175,80,0.2); color: #4caf50; }
                    .difficulty-medium { background: rgba(255,152,0,0.2); color: #ff9800; }
                    .problem-desc { line-height: 1.8; color: #8892b0; white-space: pre-wrap; }
                    .example-box { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin: 15px 0; }
                    .example-title { color: #00ff88; font-weight: 600; margin-bottom: 10px; }
                    .example-code { background: #1e1e1e; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 13px; }
                    .action-buttons { display: flex; gap: 10px; }
                    .btn-run { background: #4ec9b0; color: #1e1e1e; }
                    .btn-submit { background: linear-gradient(135deg, #00d9ff, #00ff88); color: #1e1e1e; }
                </style>
                
                <div class="problem-panel">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <select id="problemSelect" onchange="loadProblem()" style="flex:1; background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:10px; border-radius:8px;">
                            <option value="">ë¬¸ì œ ì„ íƒ...</option>
                        </select>
                    </div>
                    <div id="problemContent">
                        <div class="problem-title">ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                        <p class="problem-desc">ì™¼ìª½ ë“œë¡­ë‹¤ìš´ì—ì„œ í’€ê³  ì‹¶ì€ ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    </div>
                </div>
                
                <div class="code-panel">
                    <div class="editor-wrapper">
                        <div class="editor-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #dcdcaa;">ğŸ“„</span>
                                <span id="fileName">solution.py</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <select id="languageSelect" onchange="changeLanguage()">
                                    <option value="python">Python</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="java">Java</option>
                                    <option value="c">C</option>
                                    <option value="cpp">C++</option>
                                </select>
                                <div class="action-buttons">
                                    <button class="btn btn-run" onclick="runCode()">â–¶ ì‹¤í–‰</button>
                                    <button class="btn btn-submit" onclick="submitCode()">ì œì¶œ</button>
                                </div>
                            </div>
                        </div>
                        <textarea id="codeEditor" spellcheck="false"># Python ì†”ë£¨ì…˜
# ì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”

def solution():
    pass

solution()</textarea>
                    </div>
                    
                    <div class="output-panel">
                        <div class="output-header">
                            <span>ğŸ“¤ ì‹¤í–‰ ê²°ê³¼</span>
                            <span id="testResultBadge" style="font-size: 12px; color: #8892b0;">í…ŒìŠ¤íŠ¸: 0/0</span>
                        </div>
                        <div class="output-content" id="outputContent">
                            ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn btn-primary" onclick="showWhiteboardTransition()">
                            ë‹¤ìŒ ë‹¨ê³„: ì•„í‚¤í…ì²˜ ì„¤ê³„ â†’
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="showFinalReport()">
                            ê±´ë„ˆë›°ê³  ê²°ê³¼ ë³´ê¸°
                        </button>
                    </div>
                </div>
            `;
            
            document.querySelector('.container').appendChild(codingContainer);
            
            // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
            await loadProblems();
        }
        
        // ========== ì½”ë”© í…ŒìŠ¤íŠ¸ ë³€ìˆ˜ ==========
        let currentProblem = null;
        let currentLanguage = 'python';
        let codingTestResults = [];
        
        // ========== ë¬¸ì œ ëª©ë¡ ë¡œë“œ ==========
        async function loadProblems() {
            try {
                const response = await fetch('/api/coding/problems');
                const data = await response.json();
                
                const select = document.getElementById('problemSelect');
                if (select) {
                    data.problems.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = `[${p.difficulty.toUpperCase()}] ${p.title}`;
                        select.appendChild(option);
                    });
                    
                    // ì²« ë²ˆì§¸ ë¬¸ì œ ìë™ ì„ íƒ
                    if (data.problems.length > 0) {
                        select.value = data.problems[0].id;
                        await loadProblem();
                    }
                }
            } catch (e) {
                console.error('ë¬¸ì œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ========== ë¬¸ì œ ë¡œë“œ ==========
        async function loadProblem() {
            const problemId = document.getElementById('problemSelect').value;
            if (!problemId) return;
            
            try {
                const response = await fetch(`/api/coding/problems/${problemId}`);
                currentProblem = await response.json();
                
                const content = document.getElementById('problemContent');
                const diffClass = currentProblem.difficulty === 'easy' ? 'difficulty-easy' : 
                                 currentProblem.difficulty === 'medium' ? 'difficulty-medium' : 'difficulty-hard';
                
                let examplesHtml = '';
                if (currentProblem.examples) {
                    examplesHtml = currentProblem.examples.map((ex, i) => `
                        <div class="example-box">
                            <div class="example-title">ì˜ˆì œ ${i + 1}</div>
                            <div><strong>ì…ë ¥:</strong></div>
                            <div class="example-code">${escapeHtml(ex.input)}</div>
                            <div style="margin-top:10px;"><strong>ì¶œë ¥:</strong></div>
                            <div class="example-code">${escapeHtml(ex.output)}</div>
                            ${ex.explanation ? `<div style="margin-top:10px; color:#8892b0; font-size:13px;">${ex.explanation}</div>` : ''}
                        </div>
                    `).join('');
                }
                
                content.innerHTML = `
                    <div class="problem-title">
                        ${currentProblem.title}
                        <span class="difficulty-badge ${diffClass}">${currentProblem.difficulty.toUpperCase()}</span>
                    </div>
                    <div class="problem-desc">${currentProblem.description}</div>
                    ${examplesHtml}
                    ${currentProblem.hints ? `<div style="margin-top:15px; padding:12px; background:rgba(0,217,255,0.1); border-radius:8px; border-left:3px solid #00d9ff;"><strong>ğŸ’¡ íŒíŠ¸:</strong> ${currentProblem.hints[0]}</div>` : ''}
                `;
                
                // í…œí”Œë¦¿ ì½”ë“œ ë¡œë“œ
                await loadTemplate();
                
            } catch (e) {
                console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ========== í…œí”Œë¦¿ ë¡œë“œ ==========
        async function loadTemplate() {
            try {
                const response = await fetch(`/api/coding/templates/${currentLanguage}`);
                const data = await response.json();
                document.getElementById('codeEditor').value = data.template;
            } catch (e) {
                document.getElementById('codeEditor').value = getDefaultTemplate(currentLanguage);
            }
        }
        
        function getDefaultTemplate(lang) {
            const templates = {
                'python': `# Python ì†”ë£¨ì…˜
def solution():
    # TODO: êµ¬í˜„
    pass

solution()`,
                'javascript': `// JavaScript ì†”ë£¨ì…˜
function solution() {
    // TODO: êµ¬í˜„
}

solution();`,
                'java': `import java.util.*;

public class Solution {
    public static void main(String[] args) {
        Scanner sc = new Scanner(System.in);
        // TODO: êµ¬í˜„
    }
}`,
                'c': `#include <stdio.h>

int main() {
    // TODO: êµ¬í˜„
    
    return 0;
}`,
                'cpp': `#include <iostream>
#include <vector>
using namespace std;

int main() {
    ios_base::sync_with_stdio(false);
    cin.tie(NULL);
    
    // TODO: êµ¬í˜„
    
    return 0;
}`
            };
            return templates[lang] || templates['python'];
        }
        
        // ========== ì–¸ì–´ ë³€ê²½ ==========
        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            const extMap = {
                'python': 'py',
                'javascript': 'js',
                'java': 'java',
                'c': 'c',
                'cpp': 'cpp'
            };
            const ext = extMap[currentLanguage] || 'txt';
            document.getElementById('fileName').textContent = `solution.${ext}`;
            loadTemplate();
        }
        
        // ========== ì½”ë“œ ì‹¤í–‰ ==========
        async function runCode() {
            const code = document.getElementById('codeEditor').value;
            const output = document.getElementById('outputContent');
            
            output.innerHTML = '<div style="color:#00d9ff;">â³ ì‹¤í–‰ ì¤‘...</div>';
            
            try {
                const response = await fetch('/api/coding/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, language: currentLanguage })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    output.innerHTML = `<div style="color:#00ff88;">âœ… ì‹¤í–‰ ì„±ê³µ (${result.execution_time}ms)</div><pre style="margin-top:10px; color:#d4d4d4;">${escapeHtml(result.output) || '(ì¶œë ¥ ì—†ìŒ)'}</pre>`;
                } else {
                    output.innerHTML = `<div style="color:#f44336;">âŒ ì˜¤ë¥˜</div><pre style="margin-top:10px; color:#f44336;">${escapeHtml(result.error)}</pre>`;
                }
            } catch (e) {
                output.innerHTML = `<div style="color:#f44336;">âŒ ì‹¤í–‰ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }
        
        // ========== ì½”ë“œ ì œì¶œ ==========
        async function submitCode() {
            if (!currentProblem) {
                alert('ë¬¸ì œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const code = document.getElementById('codeEditor').value;
            const output = document.getElementById('outputContent');
            
            output.innerHTML = '<div style="color:#00d9ff;">â³ AI ë¶„ì„ ì¤‘...</div>';
            
            try {
                const response = await fetch('/api/coding/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code,
                        language: currentLanguage,
                        problem_id: currentProblem.id
                    })
                });
                
                const result = await response.json();
                
                // ê²°ê³¼ ì €ì¥
                codingTestResults.push({
                    problem: currentProblem.title,
                    ...result
                });
                
                // í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
                const passed = result.summary?.passed || 0;
                const total = result.summary?.total || 0;
                
                document.getElementById('testResultBadge').textContent = `í…ŒìŠ¤íŠ¸: ${passed}/${total}`;
                document.getElementById('testResultBadge').style.color = passed === total ? '#00ff88' : '#f44336';
                
                let html = '';
                if (result.test_results) {
                    result.test_results.forEach((tr, i) => {
                        html += `
                            <div class="test-result ${tr.passed ? 'passed' : 'failed'}">
                                <span style="margin-right:10px;">${tr.passed ? 'âœ…' : 'âŒ'}</span>
                                <span>í…ŒìŠ¤íŠ¸ ${i + 1}</span>
                                <span style="margin-left:auto; color:#8892b0;">${tr.execution_time?.toFixed(1) || 0}ms</span>
                            </div>
                        `;
                    });
                }
                
                if (result.analysis) {
                    html += `
                        <div style="margin-top:15px; padding:15px; background:rgba(0,217,255,0.1); border-radius:8px;">
                            <div style="font-size:24px; text-align:center; margin-bottom:10px;">
                                ğŸ¯ <strong style="color:#00d9ff;">${result.analysis.overall_score}</strong>/100ì 
                            </div>
                            <div style="font-size:12px; color:#8892b0;">
                                ì‹œê°„ë³µì¡ë„: ${result.analysis.time_complexity?.estimated || 'N/A'} | 
                                ì½”ë“œìŠ¤íƒ€ì¼: ${result.analysis.code_style?.score || 0}/20
                            </div>
                        </div>
                    `;
                }
                
                output.innerHTML = html || '<div style="color:#8892b0;">ê²°ê³¼ ì—†ìŒ</div>';
                
            } catch (e) {
                output.innerHTML = `<div style="color:#f44336;">âŒ ì œì¶œ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== í™”ì´íŠ¸ë³´ë“œ ì „í™˜ í™”ë©´ ==========
        function showWhiteboardTransition() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'whiteboardTransitionModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px; text-align: center;">
                    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“</div>
                    <h2 style="margin-bottom: 15px;">ì½”ë”© í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</h2>
                    <p style="color: #8892b0; margin-bottom: 30px; line-height: 1.6;">
                        ë‹¤ìŒ ë‹¨ê³„ë¡œ <strong style="color: #9b59b6;">ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„</strong>ê°€ ì§„í–‰ë©ë‹ˆë‹¤.<br>
                        í™”ì´íŠ¸ë³´ë“œì— ë‹¤ì´ì–´ê·¸ë¨ì„ ê·¸ë¦¬ê³  AIê°€ ë¶„ì„í•©ë‹ˆë‹¤.
                    </p>
                    <div style="background: rgba(155,89,182,0.1); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="font-size: 24px;">ğŸ¨</div>
                                <div style="font-size: 12px; color: #8892b0; margin-top: 5px;">ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„±</div>
                            </div>
                            <div>
                                <div style="font-size: 24px;">ğŸ¤–</div>
                                <div style="font-size: 12px; color: #8892b0; margin-top: 5px;">Claude Vision ë¶„ì„</div>
                            </div>
                            <div>
                                <div style="font-size: 24px;">ğŸ“Š</div>
                                <div style="font-size: 12px; color: #8892b0; margin-top: 5px;">ì•„í‚¤í…ì²˜ í‰ê°€</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="startWhiteboard()" style="padding: 15px 40px; font-size: 16px; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                            ì•„í‚¤í…ì²˜ ì„¤ê³„ ì‹œì‘ ğŸ“
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="skipWhiteboard()">
                            ê±´ë„ˆë›°ê¸°
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ========== í™”ì´íŠ¸ë³´ë“œ ê±´ë„ˆë›°ê¸° ==========
        function skipWhiteboard() {
            const modal = document.getElementById('whiteboardTransitionModal');
            if (modal) modal.remove();
            showFinalReport();
        }
        
        // ========== í™”ì´íŠ¸ë³´ë“œ ì‹œì‘ ==========
        async function startWhiteboard() {
            const modal = document.getElementById('whiteboardTransitionModal');
            if (modal) modal.remove();
            
            // ì½”ë”© í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì œê±°
            const codingContainer = document.getElementById('codingTestContainer');
            if (codingContainer) codingContainer.remove();
            
            // í—¤ë” ì—…ë°ì´íŠ¸
            document.querySelector('.header h1').textContent = 'ğŸ“ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„';
            
            // í™”ì´íŠ¸ë³´ë“œ í™”ë©´ í‘œì‹œ
            await showWhiteboardScreen();
        }
        
        // ========== í™”ì´íŠ¸ë³´ë“œ í™”ë©´ ==========
        async function showWhiteboardScreen() {
            const whiteboardContainer = document.createElement('div');
            whiteboardContainer.id = 'whiteboardContainer';
            whiteboardContainer.innerHTML = `
                <div style="display: flex; gap: 20px; padding: 20px; height: calc(100vh - 120px);">
                    <!-- ì¢Œì¸¡: ë¬¸ì œ ë° ë„êµ¬ -->
                    <div style="width: 320px; display: flex; flex-direction: column; gap: 15px;">
                        <!-- ë¬¸ì œ ìƒì„± -->
                        <div class="panel" style="flex: 0 0 auto;">
                            <div class="panel-header">ğŸ² AI ë¬¸ì œ ìƒì„±</div>
                            <div style="margin-top: 10px;">
                                <div style="font-size: 12px; color: #8892b0; margin-bottom: 5px;">ì¹´í…Œê³ ë¦¬</div>
                                <select id="archCategorySelect" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;">
                                    <option value="">ëœë¤ ì„ íƒ</option>
                                </select>
                            </div>
                            <div style="margin-top: 10px;">
                                <div style="font-size: 12px; color: #8892b0; margin-bottom: 5px;">ë‚œì´ë„</div>
                                <select id="archDifficultySelect" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;">
                                    <option value="">ëœë¤ ì„ íƒ</option>
                                    <option value="easy">ğŸŸ¢ Easy</option>
                                    <option value="medium">ğŸŸ¡ Medium</option>
                                    <option value="hard">ğŸ”´ Hard</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="generateNewProblem()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                                ğŸ² ìƒˆ ë¬¸ì œ ìƒì„±
                            </button>
                        </div>
                        
                        <!-- í˜„ì¬ ë¬¸ì œ -->
                        <div class="panel" style="flex: 0 0 auto; max-height: 250px; overflow-y: auto;">
                            <div class="panel-header">ğŸ“‹ í˜„ì¬ ë¬¸ì œ</div>
                            <div id="archProblemDesc" style="margin-top: 10px; font-size: 13px; color: #8892b0; line-height: 1.6;">
                                <div style="text-align: center; padding: 20px; color: #555;">
                                    ğŸ² 'ìƒˆ ë¬¸ì œ ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬<br>AIê°€ ìƒì„±í•œ ë¬¸ì œë¥¼ ë°›ì•„ë³´ì„¸ìš”
                                </div>
                            </div>
                        </div>
                        
                        <!-- ê·¸ë¦¬ê¸° ë„êµ¬ -->
                        <div class="panel" style="flex: 0 0 auto;">
                            <div class="panel-header">ğŸ¨ ê·¸ë¦¬ê¸° ë„êµ¬</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                <button class="tool-btn active" id="tool-pen" onclick="selectTool('pen')" title="íœ">âœï¸</button>
                                <button class="tool-btn" id="tool-line" onclick="selectTool('line')" title="ì§ì„ ">ğŸ“</button>
                                <button class="tool-btn" id="tool-rect" onclick="selectTool('rect')" title="ì‚¬ê°í˜•">â¬œ</button>
                                <button class="tool-btn" id="tool-circle" onclick="selectTool('circle')" title="ì›">â­•</button>
                                <button class="tool-btn" id="tool-arrow" onclick="selectTool('arrow')" title="í™”ì‚´í‘œ">â¡ï¸</button>
                                <button class="tool-btn" id="tool-text" onclick="selectTool('text')" title="í…ìŠ¤íŠ¸">ğŸ“</button>
                                <button class="tool-btn" id="tool-eraser" onclick="selectTool('eraser')" title="ì§€ìš°ê°œ">ğŸ§¹</button>
                            </div>
                            
                            <!-- ìƒ‰ìƒ ì„ íƒ -->
                            <div style="margin-top: 15px;">
                                <div style="font-size: 12px; color: #8892b0; margin-bottom: 8px;">ìƒ‰ìƒ</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <div class="color-btn active" style="background: #00d9ff;" onclick="selectColor('#00d9ff')"></div>
                                    <div class="color-btn" style="background: #00ff88;" onclick="selectColor('#00ff88')"></div>
                                    <div class="color-btn" style="background: #f39c12;" onclick="selectColor('#f39c12')"></div>
                                    <div class="color-btn" style="background: #e74c3c;" onclick="selectColor('#e74c3c')"></div>
                                    <div class="color-btn" style="background: #9b59b6;" onclick="selectColor('#9b59b6')"></div>
                                    <div class="color-btn" style="background: #ffffff;" onclick="selectColor('#ffffff')"></div>
                                </div>
                            </div>
                            
                            <!-- ì„  êµµê¸° -->
                            <div style="margin-top: 15px;">
                                <div style="font-size: 12px; color: #8892b0; margin-bottom: 8px;">ì„  êµµê¸°: <span id="lineWidthValue">3</span>px</div>
                                <input type="range" id="lineWidthSlider" min="1" max="10" value="3" oninput="changeLineWidth(this.value)" style="width: 100%;">
                            </div>
                        </div>
                        
                        <!-- ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ -->
                        <div class="panel" style="flex: 0 0 auto;">
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="undoDraw()" style="flex: 1;">â†¶ ì‹¤í–‰ì·¨ì†Œ</button>
                                <button class="btn" onclick="redoDraw()" style="flex: 1;">â†· ë‹¤ì‹œì‹¤í–‰</button>
                            </div>
                            <button class="btn" onclick="clearCanvas()" style="width: 100%; margin-top: 10px; background: rgba(231,76,60,0.3);">ğŸ—‘ï¸ ì „ì²´ ì§€ìš°ê¸°</button>
                        </div>
                    </div>
                    
                    <!-- ì¤‘ì•™: ìº”ë²„ìŠ¤ -->
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
                        <div class="panel" style="flex: 1; position: relative; overflow: hidden;">
                            <canvas id="whiteboardCanvas" style="width: 100%; height: 100%; background: #1a1a2e; border-radius: 8px; cursor: crosshair;"></canvas>
                        </div>
                        
                        <!-- ì„¤ëª… ì…ë ¥ -->
                        <div class="panel" style="flex: 0 0 auto;">
                            <div class="panel-header">ğŸ’¬ ì•„í‚¤í…ì²˜ ì„¤ëª…</div>
                            <textarea id="archExplanation" placeholder="ì„¤ê³„í•œ ì•„í‚¤í…ì²˜ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”. (ì„ íƒì‚¬í•­)" style="width: 100%; height: 80px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; padding: 10px; resize: none; margin-top: 10px;"></textarea>
                        </div>
                    </div>
                    
                    <!-- ìš°ì¸¡: ë¶„ì„ ê²°ê³¼ -->
                    <div style="width: 350px; display: flex; flex-direction: column; gap: 15px;">
                        <div class="panel" style="flex: 1; overflow-y: auto;">
                            <div class="panel-header">ğŸ¤– AI ë¶„ì„ ê²°ê³¼</div>
                            <div id="analysisResult" style="margin-top: 10px; color: #8892b0; font-size: 13px;">
                                ë‹¤ì´ì–´ê·¸ë¨ì„ ì™„ì„±í•˜ê³  'ë¶„ì„í•˜ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="analyzeWhiteboard()" style="flex: 1; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                                ğŸ” ë¶„ì„í•˜ê¸°
                            </button>
                        </div>
                        <button class="btn btn-primary" onclick="showFinalReport()" style="background: linear-gradient(135deg, #00d9ff, #00ff88);">
                            âœ… ë©´ì ‘ ì™„ë£Œ ë° ê²°ê³¼ ë³´ê¸°
                        </button>
                    </div>
                </div>
                
                <style>
                    .tool-btn {
                        width: 40px;
                        height: 40px;
                        border: 1px solid rgba(255,255,255,0.2);
                        border-radius: 8px;
                        background: rgba(0,0,0,0.3);
                        cursor: pointer;
                        font-size: 18px;
                        transition: all 0.2s;
                    }
                    .tool-btn:hover {
                        background: rgba(155,89,182,0.3);
                    }
                    .tool-btn.active {
                        background: rgba(155,89,182,0.5);
                        border-color: #9b59b6;
                    }
                    .color-btn {
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        cursor: pointer;
                        border: 2px solid transparent;
                        transition: all 0.2s;
                    }
                    .color-btn:hover, .color-btn.active {
                        border-color: white;
                        transform: scale(1.1);
                    }
                </style>
            `;
            
            document.querySelector('.container').appendChild(whiteboardContainer);
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            initWhiteboardCanvas();
            
            // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
            await loadArchProblems();
        }
        
        // ========== ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ==========
        function initWhiteboardCanvas() {
            whiteboardCanvas = document.getElementById('whiteboardCanvas');
            whiteboardCtx = whiteboardCanvas.getContext('2d');
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
            const container = whiteboardCanvas.parentElement;
            whiteboardCanvas.width = container.clientWidth;
            whiteboardCanvas.height = container.clientHeight;
            
            // ë°°ê²½ ìƒ‰ìƒ
            whiteboardCtx.fillStyle = '#1a1a2e';
            whiteboardCtx.fillRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
            
            // ì´ˆê¸° ìƒíƒœ ì €ì¥
            saveDrawState();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            whiteboardCanvas.addEventListener('mousedown', startDrawing);
            whiteboardCanvas.addEventListener('mousemove', draw);
            whiteboardCanvas.addEventListener('mouseup', stopDrawing);
            whiteboardCanvas.addEventListener('mouseout', stopDrawing);
            
            // í„°ì¹˜ ì§€ì›
            whiteboardCanvas.addEventListener('touchstart', handleTouchStart);
            whiteboardCanvas.addEventListener('touchmove', handleTouchMove);
            whiteboardCanvas.addEventListener('touchend', stopDrawing);
            
            // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
            window.addEventListener('resize', resizeWhiteboardCanvas);
        }
        
        function resizeWhiteboardCanvas() {
            if (!whiteboardCanvas) return;
            const container = whiteboardCanvas.parentElement;
            const imageData = whiteboardCtx.getImageData(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
            whiteboardCanvas.width = container.clientWidth;
            whiteboardCanvas.height = container.clientHeight;
            whiteboardCtx.putImageData(imageData, 0, 0);
        }
        
        // ========== ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤ ==========
        function startDrawing(e) {
            isDrawing = true;
            const rect = whiteboardCanvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            if (currentTool === 'text') {
                addTextToCanvas(lastX, lastY);
                isDrawing = false;
            }
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = whiteboardCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            whiteboardCtx.strokeStyle = currentTool === 'eraser' ? '#1a1a2e' : currentColor;
            whiteboardCtx.lineWidth = currentTool === 'eraser' ? lineWidth * 5 : lineWidth;
            whiteboardCtx.lineCap = 'round';
            whiteboardCtx.lineJoin = 'round';
            
            if (currentTool === 'pen' || currentTool === 'eraser') {
                whiteboardCtx.beginPath();
                whiteboardCtx.moveTo(lastX, lastY);
                whiteboardCtx.lineTo(x, y);
                whiteboardCtx.stroke();
            }
            
            lastX = x;
            lastY = y;
        }
        
        function stopDrawing(e) {
            if (!isDrawing) return;
            
            const rect = whiteboardCanvas.getBoundingClientRect();
            const x = e.clientX ? e.clientX - rect.left : lastX;
            const y = e.clientY ? e.clientY - rect.top : lastY;
            
            // ë„í˜• ê·¸ë¦¬ê¸°
            if (currentTool === 'line') {
                whiteboardCtx.strokeStyle = currentColor;
                whiteboardCtx.lineWidth = lineWidth;
                whiteboardCtx.beginPath();
                whiteboardCtx.moveTo(lastX, lastY);
                whiteboardCtx.lineTo(x, y);
                whiteboardCtx.stroke();
            } else if (currentTool === 'rect') {
                whiteboardCtx.strokeStyle = currentColor;
                whiteboardCtx.lineWidth = lineWidth;
                whiteboardCtx.strokeRect(lastX, lastY, x - lastX, y - lastY);
            } else if (currentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(x - lastX, 2) + Math.pow(y - lastY, 2));
                whiteboardCtx.strokeStyle = currentColor;
                whiteboardCtx.lineWidth = lineWidth;
                whiteboardCtx.beginPath();
                whiteboardCtx.arc(lastX, lastY, radius, 0, Math.PI * 2);
                whiteboardCtx.stroke();
            } else if (currentTool === 'arrow') {
                drawArrow(lastX, lastY, x, y);
            }
            
            isDrawing = false;
            saveDrawState();
        }
        
        function drawArrow(fromX, fromY, toX, toY) {
            const headLength = 15;
            const angle = Math.atan2(toY - fromY, toX - fromX);
            
            whiteboardCtx.strokeStyle = currentColor;
            whiteboardCtx.lineWidth = lineWidth;
            whiteboardCtx.beginPath();
            whiteboardCtx.moveTo(fromX, fromY);
            whiteboardCtx.lineTo(toX, toY);
            whiteboardCtx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
            whiteboardCtx.moveTo(toX, toY);
            whiteboardCtx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
            whiteboardCtx.stroke();
        }
        
        function addTextToCanvas(x, y) {
            const text = prompt('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (text) {
                whiteboardCtx.font = `${lineWidth * 5}px Arial`;
                whiteboardCtx.fillStyle = currentColor;
                whiteboardCtx.fillText(text, x, y);
                saveDrawState();
            }
        }
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            startDrawing(mouseEvent);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            draw(mouseEvent);
        }
        
        // ========== ë„êµ¬ ì„ íƒ ==========
        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool-${tool}`).classList.add('active');
        }
        
        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function changeLineWidth(value) {
            lineWidth = parseInt(value);
            document.getElementById('lineWidthValue').textContent = value;
        }
        
        // ========== ì‹¤í–‰ì·¨ì†Œ/ë‹¤ì‹œì‹¤í–‰ ==========
        function saveDrawState() {
            historyIndex++;
            drawHistory = drawHistory.slice(0, historyIndex);
            drawHistory.push(whiteboardCanvas.toDataURL());
        }
        
        function undoDraw() {
            if (historyIndex > 0) {
                historyIndex--;
                loadDrawState(drawHistory[historyIndex]);
            }
        }
        
        function redoDraw() {
            if (historyIndex < drawHistory.length - 1) {
                historyIndex++;
                loadDrawState(drawHistory[historyIndex]);
            }
        }
        
        function loadDrawState(dataUrl) {
            const img = new Image();
            img.onload = () => {
                whiteboardCtx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                whiteboardCtx.drawImage(img, 0, 0);
            };
            img.src = dataUrl;
        }
        
        function clearCanvas() {
            if (confirm('ìº”ë²„ìŠ¤ë¥¼ ì™„ì „íˆ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                whiteboardCtx.fillStyle = '#1a1a2e';
                whiteboardCtx.fillRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                saveDrawState();
            }
        }
        
        // ========== ì•„í‚¤í…ì²˜ ë¬¸ì œ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ==========
        async function loadArchProblems() {
            try {
                // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
                const response = await fetch('/api/whiteboard/categories');
                const data = await response.json();
                
                const categorySelect = document.getElementById('archCategorySelect');
                if (categorySelect) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        categorySelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ========== ìƒˆ ë¬¸ì œ ìƒì„± ==========
        async function generateNewProblem() {
            const category = document.getElementById('archCategorySelect')?.value || null;
            const difficulty = document.getElementById('archDifficultySelect')?.value || null;
            const descDiv = document.getElementById('archProblemDesc');
            
            descDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 24px; animation: spin 1s linear infinite;">ğŸ²</div>
                    <div style="color: #00d9ff; margin-top: 10px;">AIê°€ ë¬¸ì œë¥¼ ìƒì„± ì¤‘...</div>
                </div>
            `;
            
            try {
                let url = '/api/whiteboard/generate';
                const params = new URLSearchParams();
                if (category) params.append('category', category);
                if (difficulty) params.append('difficulty', difficulty);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url, { method: 'POST' });
                if (!response.ok) throw new Error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨');
                
                const problem = await response.json();
                currentArchProblem = problem;
                
                // ë‚œì´ë„ ë°°ì§€ ìƒ‰ìƒ
                const diffColors = {
                    'easy': '#00ff88',
                    'medium': '#f39c12',
                    'hard': '#e74c3c'
                };
                const diffColor = diffColors[problem.difficulty] || '#8892b0';
                
                descDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="font-size: 14px;">${problem.title}</strong>
                        <span style="background: ${diffColor}; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                            ${problem.difficulty.toUpperCase()}
                        </span>
                    </div>
                    <div style="white-space: pre-line; margin-bottom: 12px; font-size: 12px; line-height: 1.5;">${problem.description}</div>
                    <div style="margin-bottom: 10px;">
                        <strong style="font-size: 12px; color: #00d9ff;">ğŸ“Œ ìš”êµ¬ì‚¬í•­:</strong>
                        <ul style="margin: 5px 0; padding-left: 18px; font-size: 11px;">
                            ${problem.requirements.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #8892b0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: 8px;">
                        <span>â±ï¸ ì œí•œì‹œê°„: ${problem.time_limit}ë¶„</span>
                        <span>ğŸ“ ${problem.category || 'ì¼ë°˜'}</span>
                    </div>
                `;
                
                // ìƒˆ ë¬¸ì œ ìƒì„± ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                console.log('âœ… ìƒˆ ë¬¸ì œ ìƒì„±ë¨:', problem.title);
                
            } catch (e) {
                console.error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨:', e);
                descDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        âŒ ë¬¸ì œ ìƒì„± ì‹¤íŒ¨<br>
                        <button class="btn" onclick="generateNewProblem()" style="margin-top: 10px;">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }
        
        // ========== ê¸°ì¡´ ë¬¸ì œ ì„ íƒ (í˜¸í™˜ì„±) ==========
        async function selectArchProblem() {
            const select = document.getElementById('archProblemSelect');
            if (!select) return;
            
            const problemId = select.value;
            
            if (!problemId) {
                document.getElementById('archProblemDesc').innerHTML = '';
                currentArchProblem = null;
                return;
            }
            
            try {
                const response = await fetch(`/api/whiteboard/problems/${problemId}`);
                const problem = await response.json();
                currentArchProblem = problem;
                
                document.getElementById('archProblemDesc').innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>${problem.title}</strong></div>
                    <div style="white-space: pre-line; margin-bottom: 10px;">${problem.description}</div>
                    <div style="margin-bottom: 10px;">
                        <strong>ìš”êµ¬ì‚¬í•­:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            ${problem.requirements.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="color: #f39c12;">â±ï¸ ì œí•œì‹œê°„: ${problem.time_limit}ë¶„</div>
                `;
            } catch (e) {
                console.error('ë¬¸ì œ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
        
        // ========== í™”ì´íŠ¸ë³´ë“œ ë¶„ì„ ==========
        async function analyzeWhiteboard() {
            const analysisResult = document.getElementById('analysisResult');
            analysisResult.innerHTML = '<div style="color: #00d9ff;">ğŸ”„ Claude Visionì´ ë‹¤ì´ì–´ê·¸ë¨ì„ ë¶„ì„ ì¤‘...</div>';
            
            try {
                // ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                const imageData = whiteboardCanvas.toDataURL('image/png');
                const explanation = document.getElementById('archExplanation').value;
                
                const response = await fetch('/api/whiteboard/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_data: imageData,
                        session_id: sessionId,
                        problem_context: currentArchProblem?.id || null,
                        user_explanation: explanation || null
                    })
                });
                
                if (!response.ok) throw new Error('ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨');
                
                const data = await response.json();
                const result = data.result;
                
                // ê²°ê³¼ ì €ì¥
                whiteboardResults.push(result);
                
                // ê²°ê³¼ í‘œì‹œ
                analysisResult.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #9b59b6, #00d9ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            ${result.overall_score}<span style="font-size: 20px;">/100</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #8892b0;">êµ¬ì¡°</div>
                            <div style="font-size: 18px; color: #00d9ff;">${result.architecture_evaluation.structure_score || 0}/25</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #8892b0;">í™•ì¥ì„±</div>
                            <div style="font-size: 18px; color: #00ff88;">${result.architecture_evaluation.scalability_score || 0}/25</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #8892b0;">ë³´ì•ˆ</div>
                            <div style="font-size: 18px; color: #f39c12;">${result.architecture_evaluation.security_score || 0}/25</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #8892b0;">ì„±ëŠ¥</div>
                            <div style="font-size: 18px; color: #9b59b6;">${result.architecture_evaluation.performance_score || 0}/25</div>
                        </div>
                    </div>
                    
                    ${result.strengths.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #00ff88; font-weight: 500; margin-bottom: 5px;">âœ… ê°•ì </div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                ${result.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${result.weaknesses.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #f39c12; font-weight: 500; margin-bottom: 5px;">âš ï¸ ê°œì„ ì </div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                ${result.weaknesses.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${result.feedback.length > 0 ? `
                        <div>
                            <div style="color: #00d9ff; font-weight: 500; margin-bottom: 5px;">ğŸ’¡ í”¼ë“œë°±</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                                ${result.feedback.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                
            } catch (e) {
                analysisResult.innerHTML = `<div style="color: #e74c3c;">âŒ ë¶„ì„ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }
        
        // ========== ìµœì¢… ë¦¬í¬íŠ¸ í‘œì‹œ ==========
        async function showFinalReport() {
            // ì½”ë”© í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì œê±°
            const codingContainer = document.getElementById('codingTestContainer');
            if (codingContainer) codingContainer.remove();
            
            // í™”ì´íŠ¸ë³´ë“œ ì»¨í…Œì´ë„ˆ ì œê±°
            const whiteboardContainer = document.getElementById('whiteboardContainer');
            if (whiteboardContainer) whiteboardContainer.remove();
            
            // ë©´ì ‘ ë¦¬í¬íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let interviewReport = null;
            try {
                const response = await fetch(`/api/report/${sessionId}`);
                interviewReport = await response.json();
            } catch (e) {
                console.error('ë©´ì ‘ ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
            
            // ì½”ë”© í…ŒìŠ¤íŠ¸ ì ìˆ˜ ê³„ì‚°
            let codingScore = 0;
            if (codingTestResults.length > 0) {
                codingScore = Math.round(
                    codingTestResults.reduce((sum, r) => sum + (r.analysis?.overall_score || 0), 0) / codingTestResults.length
                );
            }
            
            // í™”ì´íŠ¸ë³´ë“œ ì ìˆ˜ ê³„ì‚°
            let whiteboardScore = 0;
            if (whiteboardResults.length > 0) {
                whiteboardScore = Math.round(
                    whiteboardResults.reduce((sum, r) => sum + (r.overall_score || 0), 0) / whiteboardResults.length
                );
            }
            
            // í—¤ë” ì—…ë°ì´íŠ¸
            document.querySelector('.header h1').textContent = 'ğŸ“‹ ë©´ì ‘ ê²°ê³¼';
            
            // ìµœì¢… ë¦¬í¬íŠ¸ ëª¨ë‹¬
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px; text-align: left; max-height: 90vh; overflow-y: auto;">
                    <h2 style="text-align:center; margin-bottom:25px;">ğŸ“‹ ì¢…í•© ë©´ì ‘ ê²°ê³¼</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                        <!-- í™”ìƒ ë©´ì ‘ ê²°ê³¼ -->
                        <div style="background: rgba(0,217,255,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #8892b0; margin-bottom: 10px;">ğŸ¥ í™”ìƒ ë©´ì ‘</div>
                            <div style="font-size: 32px; font-weight: 700; color: #00d9ff;">
                                ${interviewReport?.llm_evaluation?.average_total || 0}<span style="font-size: 16px; color: #8892b0;">/25</span>
                            </div>
                        </div>
                        
                        <!-- ì½”ë”© í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
                        <div style="background: rgba(0,255,136,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #8892b0; margin-bottom: 10px;">ğŸ’» ì½”ë”© í…ŒìŠ¤íŠ¸</div>
                            <div style="font-size: 32px; font-weight: 700; color: #00ff88;">
                                ${codingScore}<span style="font-size: 16px; color: #8892b0;">/100</span>
                            </div>
                        </div>
                        
                        <!-- ì•„í‚¤í…ì²˜ ì„¤ê³„ ê²°ê³¼ -->
                        <div style="background: rgba(155,89,182,0.1); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #8892b0; margin-bottom: 10px;">ğŸ“ ì•„í‚¤í…ì²˜ ì„¤ê³„</div>
                            <div style="font-size: 32px; font-weight: 700; color: #9b59b6;">
                                ${whiteboardScore}<span style="font-size: 16px; color: #8892b0;">/100</span>
                            </div>
                        </div>
                    </div>
                    
                    ${interviewReport?.feedback?.length ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: #00d9ff;">ğŸ’¡ ë©´ì ‘ í”¼ë“œë°±</h3>
                        <ul style="color: #8892b0; line-height: 1.8; padding-left: 20px;">
                            ${interviewReport.feedback.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${codingTestResults.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: #00ff88;">ğŸ’» ì½”ë”© í…ŒìŠ¤íŠ¸ ìƒì„¸</h3>
                        ${codingTestResults.map(r => `
                            <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${r.problem}</span>
                                    <span style="color: #00ff88; font-weight: 600;">${r.analysis?.overall_score || 0}ì </span>
                                </div>
                                <div style="font-size: 12px; color: #8892b0; margin-top: 5px;">
                                    í…ŒìŠ¤íŠ¸: ${r.summary?.passed || 0}/${r.summary?.total || 0} í†µê³¼
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : '<div style="color: #8892b0; margin-bottom: 20px;">ì½”ë”© í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>'}
                    
                    ${whiteboardResults.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: #9b59b6;">ğŸ“ ì•„í‚¤í…ì²˜ ì„¤ê³„ ìƒì„¸</h3>
                        ${whiteboardResults.map((r, idx) => `
                            <div style="background: rgba(155,89,182,0.1); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span>ì•„í‚¤í…ì²˜ ì„¤ê³„ #${idx + 1}</span>
                                    <span style="color: #9b59b6; font-weight: 600;">${r.overall_score || 0}ì </span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; font-size: 11px;">
                                    <div style="text-align: center; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                        <div style="color: #8892b0;">êµ¬ì¡°</div>
                                        <div style="color: #00d9ff;">${r.architecture_evaluation?.structure_score || 0}</div>
                                    </div>
                                    <div style="text-align: center; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                        <div style="color: #8892b0;">í™•ì¥</div>
                                        <div style="color: #00ff88;">${r.architecture_evaluation?.scalability_score || 0}</div>
                                    </div>
                                    <div style="text-align: center; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                        <div style="color: #8892b0;">ë³´ì•ˆ</div>
                                        <div style="color: #f39c12;">${r.architecture_evaluation?.security_score || 0}</div>
                                    </div>
                                    <div style="text-align: center; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                        <div style="color: #8892b0;">ì„±ëŠ¥</div>
                                        <div style="color: #9b59b6;">${r.architecture_evaluation?.performance_score || 0}</div>
                                    </div>
                                </div>
                                ${r.feedback?.length > 0 ? `
                                <div style="margin-top: 8px; font-size: 12px; color: #8892b0;">
                                    ğŸ’¡ ${r.feedback[0]}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ` : '<div style="color: #8892b0; margin-bottom: 20px;">ì•„í‚¤í…ì²˜ ì„¤ê³„ë¥¼ ì™„ë£Œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>'}
                    
                    <div class="modal-buttons" style="justify-content: center;">
                        <button class="btn btn-primary" onclick="location.href='/'">í™ˆìœ¼ë¡œ</button>
                        <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="location.reload()">ìƒˆ ë©´ì ‘ ì‹œì‘</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ========== ì´ë ¥ì„œ ì—…ë¡œë“œ ==========
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('uploadBtn').disabled = false;
            }
        }
        
        async function uploadResume() {
            const fileInput = document.getElementById('resumeFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                document.getElementById('uploadBtn').textContent = 'ì—…ë¡œë“œ ì¤‘...';
                document.getElementById('uploadBtn').disabled = true;
                
                const response = await fetch('/api/resume/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.session_id;
                    document.getElementById('resumeModal').classList.remove('active');
                    await beginInterview();
                } else {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                }
                
            } catch (err) {
                console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', err);
                alert('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                document.getElementById('resumeFile').files = files;
                document.getElementById('fileName').textContent = files[0].name;
                document.getElementById('uploadBtn').disabled = false;
            }
        });
    </script>
</body>
</html>
