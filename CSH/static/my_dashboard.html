<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´ ëŒ€ì‹œë³´ë“œ - AI ëª¨ì˜ë©´ì ‘</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* ========== í—¤ë” ========== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 32px;
            background: rgba(20,20,40,0.95);
            border-bottom: 1px solid rgba(0,217,255,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        .header-logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .user-greeting {
            color: #8892b0;
            font-size: 14px;
        }
        .user-greeting strong {
            color: #00d9ff;
        }
        .header-btn {
            padding: 8px 18px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(0,217,255,0.4);
            color: #00d9ff;
        }
        .btn-outline:hover { background: rgba(0,217,255,0.1); }
        .btn-danger {
            background: transparent;
            border: 1px solid rgba(255,82,82,0.4);
            color: #ff5252;
        }
        .btn-danger:hover { background: rgba(255,82,82,0.1); }

        /* ========== ë©”ì¸ ë ˆì´ì•„ì›ƒ ========== */
        .main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        .welcome-banner {
            background: linear-gradient(135deg, rgba(0,217,255,0.08), rgba(0,255,136,0.06));
            border: 1px solid rgba(0,217,255,0.15);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
        }
        .welcome-banner h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        .welcome-banner p {
            color: #8892b0;
            font-size: 15px;
        }

        /* ========== ì¹´ë“œ ê·¸ë¦¬ë“œ ========== */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        .card {
            background: rgba(20,20,40,0.8);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 28px;
            transition: all 0.3s;
        }
        .card:hover {
            border-color: rgba(0,217,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .card-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .card-icon.blue   { background: rgba(0,217,255,0.12); }
        .card-icon.green  { background: rgba(0,255,136,0.12); }
        .card-icon.purple { background: rgba(160,100,255,0.12); }
        .card-icon.orange { background: rgba(255,170,60,0.12); }
        .card-header h3 { font-size: 17px; font-weight: 600; }

        /* ë²„íŠ¼ ê³µí†µ */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            width: 100%;
            justify-content: center;
        }
        .action-btn.primary {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #0a0a1a;
        }
        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0,217,255,0.35);
        }
        .action-btn.secondary {
            background: rgba(255,255,255,0.06);
            color: #e0e0e0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .action-btn.secondary:hover { background: rgba(255,255,255,0.1); }

        /* ========== ì´ë ¥ì„œ ì—…ë¡œë“œ ì˜ì—­ ========== */
        .upload-area {
            border: 2px dashed rgba(0,217,255,0.25);
            border-radius: 12px;
            padding: 28px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 16px;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #00d9ff;
            background: rgba(0,217,255,0.04);
        }
        .upload-area .icon { font-size: 36px; margin-bottom: 8px; }
        .upload-area .text { color: #8892b0; font-size: 14px; }
        .upload-area .text strong { color: #00d9ff; }
        .upload-status {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            display: none;
        }
        .upload-status.success {
            display: block;
            background: rgba(0,255,136,0.08);
            border: 1px solid rgba(0,255,136,0.2);
            color: #00ff88;
        }
        .upload-status.error {
            display: block;
            background: rgba(255,82,82,0.08);
            border: 1px solid rgba(255,82,82,0.2);
            color: #ff5252;
        }
        .resume-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(0,255,136,0.06);
            border: 1px solid rgba(0,255,136,0.15);
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .resume-info .name { color: #00ff88; font-weight: 500; font-size: 14px; }
        .resume-info .remove {
            background: none; border: none; color: #ff5252;
            cursor: pointer; font-size: 13px;
        }
        .resume-info .remove:hover { text-decoration: underline; }

        /* ========== í™˜ê²½ í…ŒìŠ¤íŠ¸ ========== */
        .device-test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        .device-box {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 4/3;
        }
        .device-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #111;
        }
        .device-box .label {
            position: absolute;
            top: 8px; left: 8px;
            background: rgba(0,0,0,0.6);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #fff;
        }
        .mic-meter-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
        }
        .mic-meter-wrap .icon { font-size: 24px; }
        .mic-meter {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.08);
            border-radius: 4px;
            overflow: hidden;
        }
        .mic-meter .bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border-radius: 4px;
            transition: width 0.08s;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-indicator.ok {
            background: rgba(0,255,136,0.1);
            color: #00ff88;
        }
        .status-indicator.fail {
            background: rgba(255,82,82,0.1);
            color: #ff5252;
        }
        .status-indicator.pending {
            background: rgba(255,255,255,0.06);
            color: #8892b0;
        }
        .test-results {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        /* ========== ë©´ì ‘ ê¸°ë¡ ========== */
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: #555;
        }
        .history-empty .icon { font-size: 40px; margin-bottom: 12px; }
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            transition: all 0.2s;
        }
        .history-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(0,217,255,0.2);
        }
        .history-item .left { display: flex; flex-direction: column; gap: 4px; }
        .history-item .date { font-size: 13px; color: #8892b0; }
        .history-item .summary { font-size: 14px; font-weight: 500; }
        .history-item .score {
            font-size: 22px; font-weight: 700;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ========== ë©´ì ‘ ì‹œì‘ CTA ========== */
        .start-section {
            margin-top: 12px;
        }
        .start-cta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: 700;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #0a0a1a;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 32px rgba(0,217,255,0.25);
        }
        .start-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 48px rgba(0,217,255,0.35);
        }
        .start-cta:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ì „ì²´ ë„ˆë¹„ ì¹´ë“œ */
        .card.full { grid-column: 1 / -1; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 720px) {
            .card-grid { grid-template-columns: 1fr; }
            .device-test-grid { grid-template-columns: 1fr; }
            .header { padding: 12px 16px; }
            .main { padding: 20px 14px; }
        }
    </style>
</head>
<body>

<!-- í—¤ë” -->
<div class="header">
    <div class="header-logo" onclick="location.href='/'">ğŸ¯ AI ëª¨ì˜ë©´ì ‘</div>
    <div class="header-right">
        <span class="user-greeting" id="userGreeting"></span>
        <button class="header-btn btn-outline" onclick="location.href='/'">ğŸ  í™ˆ</button>
        <button class="header-btn btn-danger" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<!-- ë©”ì¸ -->
<div class="main">

    <!-- í™˜ì˜ ë°°ë„ˆ -->
    <div class="welcome-banner">
        <h1>ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, <span id="welcomeName">ì‚¬ìš©ì</span>ë‹˜!</h1>
        <p>ë©´ì ‘ì„ ì‹œì‘í•˜ê¸° ì „ì— ì´ë ¥ì„œë¥¼ ì—…ë¡œë“œí•˜ê³ , ë§ˆì´í¬ì™€ ì¹´ë©”ë¼ë¥¼ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.</p>
    </div>

    <div class="card-grid">

        <!-- 1) ì´ë ¥ì„œ ì—…ë¡œë“œ ì¹´ë“œ -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon blue">ğŸ“„</div>
                <h3>ì´ë ¥ì„œ ê´€ë¦¬</h3>
            </div>

            <!-- ì´ë¯¸ ì—…ë¡œë“œëœ ì´ë ¥ì„œ í‘œì‹œ -->
            <div id="resumeInfo" style="display:none;">
                <div class="resume-info">
                    <span class="name" id="resumeFileName">ì´ë ¥ì„œ.pdf</span>
                    <button class="remove" onclick="removeResume()">ì‚­ì œ</button>
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ì˜ì—­ -->
            <div id="uploadArea" class="upload-area" onclick="document.getElementById('resumeFile').click()">
                <div class="icon">ğŸ“</div>
                <div class="text"><strong>í´ë¦­</strong>í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
                <div class="text" style="margin-top:4px; font-size:12px;">PDF (ìµœëŒ€ 10MB)</div>
            </div>
            <input type="file" id="resumeFile" accept=".pdf" hidden>

            <div id="uploadStatus" class="upload-status"></div>
        </div>

        <!-- 2) í™˜ê²½ í…ŒìŠ¤íŠ¸ ì¹´ë“œ -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon green">ğŸ”§</div>
                <h3>í™˜ê²½ í…ŒìŠ¤íŠ¸</h3>
            </div>

            <div class="device-test-grid">
                <div class="device-box">
                    <video id="cameraPreview" autoplay muted playsinline></video>
                    <span class="label">ğŸ“· ì¹´ë©”ë¼</span>
                </div>
                <div style="display:flex; flex-direction:column; gap:12px; justify-content:center;">
                    <div class="mic-meter-wrap">
                        <span class="icon">ğŸ¤</span>
                        <div class="mic-meter">
                            <div class="bar" id="micBar"></div>
                        </div>
                    </div>
                    <button class="action-btn secondary" id="testBtn" onclick="toggleDeviceTest()">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
                </div>
            </div>

            <div class="test-results" id="testResults">
                <span class="status-indicator pending">ğŸ“· ì¹´ë©”ë¼: ëŒ€ê¸°</span>
                <span class="status-indicator pending">ğŸ¤ ë§ˆì´í¬: ëŒ€ê¸°</span>
            </div>
        </div>

        <!-- 3) ë©´ì ‘ ì‹œì‘ CTA (ì „ì²´ ë„ˆë¹„) -->
        <div class="card full start-section">
            <button class="start-cta" id="startInterviewBtn" onclick="goToInterview()">
                ğŸ¥ AI í™”ìƒ ë©´ì ‘ ì‹œì‘í•˜ê¸°
            </button>
        </div>

        <!-- 4) ë©´ì ‘ ê¸°ë¡ ì¹´ë“œ (ì „ì²´ ë„ˆë¹„) -->
        <div class="card full">
            <div class="card-header">
                <div class="card-icon purple">ğŸ“Š</div>
                <h3>ì´ì „ ë©´ì ‘ ê¸°ë¡</h3>
            </div>
            <div id="historyList" class="history-list">
                <div class="history-empty" id="historyEmpty">
                    <div class="icon">ğŸ“‹</div>
                    <div>ì•„ì§ ë©´ì ‘ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    <div style="font-size:13px; margin-top:6px; color:#444;">ë©´ì ‘ì„ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // ========== ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ==========
    let currentUser = null;
    let currentSessionId = null;
    let mediaStream = null;
    let audioContext = null;
    let analyser = null;
    let animFrameId = null;
    let testRunning = false;

    (function init() {
        const userData = sessionStorage.getItem('interview_user');
        if (!userData) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = '/';
            return;
        }
        try {
            currentUser = JSON.parse(userData);
        } catch {
            sessionStorage.removeItem('interview_user');
            location.href = '/';
            return;
        }

        document.getElementById('userGreeting').innerHTML =
            '<strong>' + currentUser.name + '</strong>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤';
        document.getElementById('welcomeName').textContent = currentUser.name;

        loadInterviewHistory();
    })();

    function handleLogout() {
        stopDeviceTest();
        sessionStorage.removeItem('interview_user');
        sessionStorage.removeItem('login_time');
        location.href = '/';
    }

    // ========== ì´ë ¥ì„œ ì—…ë¡œë“œ ==========
    const uploadArea = document.getElementById('uploadArea');
    const resumeFileInput = document.getElementById('resumeFile');

    uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) uploadResume(e.dataTransfer.files[0]);
    });
    resumeFileInput.addEventListener('change', () => {
        if (resumeFileInput.files.length) uploadResume(resumeFileInput.files[0]);
    });

    async function uploadResume(file) {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.className = 'upload-status';
        statusEl.style.display = 'block';
        statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘...';
        statusEl.style.color = '#8892b0';
        statusEl.style.background = 'rgba(255,255,255,0.04)';
        statusEl.style.border = '1px solid rgba(255,255,255,0.08)';

        const formData = new FormData();
        formData.append('file', file);
        if (currentSessionId) formData.append('session_id', currentSessionId);

        try {
            const res = await fetch('/api/resume/upload', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                currentSessionId = data.session_id;
                statusEl.className = 'upload-status success';
                statusEl.textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ! (' + (data.chunks_created || 0) + 'ê°œ ì²­í¬ ìƒì„±)';
                showResumeInfo(data.filename || file.name);
            } else {
                statusEl.className = 'upload-status error';
                statusEl.textContent = 'âŒ ' + (data.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
            }
        } catch (err) {
            statusEl.className = 'upload-status error';
            statusEl.textContent = 'âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜';
        }
    }

    function showResumeInfo(filename) {
        document.getElementById('resumeFileName').textContent = 'ğŸ“ ' + filename;
        document.getElementById('resumeInfo').style.display = 'block';
        document.getElementById('uploadArea').style.display = 'none';
    }

    async function removeResume() {
        if (!currentSessionId) return;
        try {
            await fetch('/api/resume/' + currentSessionId, { method: 'DELETE' });
        } catch {}
        document.getElementById('resumeInfo').style.display = 'none';
        document.getElementById('uploadArea').style.display = '';
        document.getElementById('uploadStatus').style.display = 'none';
        resumeFileInput.value = '';
    }

    // ========== í™˜ê²½ í…ŒìŠ¤íŠ¸ (ì¹´ë©”ë¼ + ë§ˆì´í¬) ==========
    async function toggleDeviceTest() {
        if (testRunning) {
            stopDeviceTest();
        } else {
            await startDeviceTest();
        }
    }

    async function startDeviceTest() {
        const resultsEl = document.getElementById('testResults');
        const btn = document.getElementById('testBtn');
        let cameraOk = false, micOk = false;

        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            testRunning = true;
            btn.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘ì§€';

            // ì¹´ë©”ë¼
            const video = document.getElementById('cameraPreview');
            video.srcObject = mediaStream;
            cameraOk = true;

            // ë§ˆì´í¬ ë ˆë²¨ ë¯¸í„°
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(mediaStream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);

            micOk = true;
            drawMicLevel();

        } catch (err) {
            console.warn('ë””ë°”ì´ìŠ¤ ì ‘ê·¼ ì˜¤ë¥˜:', err);
            if (err.name === 'NotAllowedError') {
                alert('ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }
        }

        resultsEl.innerHTML =
            '<span class="status-indicator ' + (cameraOk ? 'ok' : 'fail') + '">ğŸ“· ì¹´ë©”ë¼: ' + (cameraOk ? 'ì •ìƒ' : 'ì‹¤íŒ¨') + '</span>' +
            '<span class="status-indicator ' + (micOk ? 'ok' : 'fail') + '">ğŸ¤ ë§ˆì´í¬: ' + (micOk ? 'ì •ìƒ' : 'ì‹¤íŒ¨') + '</span>';
    }

    function drawMicLevel() {
        if (!analyser) return;
        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(data);
        const avg = data.reduce((a, b) => a + b, 0) / data.length;
        const pct = Math.min(100, (avg / 128) * 100);
        document.getElementById('micBar').style.width = pct + '%';
        animFrameId = requestAnimationFrame(drawMicLevel);
    }

    function stopDeviceTest() {
        testRunning = false;
        document.getElementById('testBtn').textContent = 'í…ŒìŠ¤íŠ¸ ì‹œì‘';
        if (animFrameId) cancelAnimationFrame(animFrameId);
        if (mediaStream) {
            mediaStream.getTracks().forEach(t => t.stop());
            mediaStream = null;
        }
        if (audioContext) {
            audioContext.close().catch(() => {});
            audioContext = null;
            analyser = null;
        }
        document.getElementById('cameraPreview').srcObject = null;
        document.getElementById('micBar').style.width = '0%';
    }

    // ========== ë©´ì ‘ ì‹œì‘ ==========
    function goToInterview() {
        stopDeviceTest();
        location.href = '/static/integrated_interview.html';
    }

    // ========== ë©´ì ‘ ê¸°ë¡ ì¡°íšŒ ==========
    async function loadInterviewHistory() {
        try {
            const res = await fetch('/api/interview/history?email=' + encodeURIComponent(currentUser.email));
            if (!res.ok) {
                // APIê°€ ì•„ì§ ì—†ì„ ìˆ˜ ìˆìŒ
                return;
            }
            const data = await res.json();
            if (!data.history || data.history.length === 0) return;

            document.getElementById('historyEmpty').style.display = 'none';
            const listEl = document.getElementById('historyList');

            data.history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML =
                    '<div class="left">' +
                        '<span class="date">' + (item.date || 'ë‚ ì§œ ì—†ìŒ') + '</span>' +
                        '<span class="summary">' + (item.summary || 'ë©´ì ‘ #' + item.session_id.slice(0, 8)) + '</span>' +
                    '</div>' +
                    '<span class="score">' + (item.score != null ? item.score + 'ì ' : '-') + '</span>';
                div.onclick = () => viewReport(item.session_id);
                listEl.appendChild(div);
            });
        } catch {
            // API ë¯¸êµ¬í˜„ ì‹œ ë¬´ì‹œ
        }
    }

    function viewReport(sessionId) {
        window.open('/api/report/' + sessionId, '_blank');
    }

    // í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ ì •ë¦¬
    window.addEventListener('beforeunload', stopDeviceTest);
</script>
</body>
</html>
