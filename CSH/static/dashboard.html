<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>AI Interview - ê°ì • ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 28px;
      margin: 0;
      background: linear-gradient(90deg, #00d9ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header p {
      color: #8892b0;
      margin-top: 8px;
    }
    .controls {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .controls input, .controls button, .controls select {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #3d4f7c;
      background: #1e2a47;
      color: #fff;
      font-size: 14px;
    }
    .controls input::placeholder { color: #8892b0; }
    .controls button {
      background: linear-gradient(90deg, #00d9ff, #00ff88);
      color: #1a1a2e;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
    }
    .controls button.stop { background: linear-gradient(90deg, #ff4757, #ff6b81); }
    .status {
      text-align: center;
      padding: 12px;
      background: rgba(0,217,255,0.1);
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .status.connected { border: 1px solid #00ff88; }
    .status.disconnected { border: 1px solid #ff4757; }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }
    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }
    
    .card {
      background: rgba(30, 42, 71, 0.8);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #3d4f7c;
      backdrop-filter: blur(10px);
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title::before {
      content: '';
      width: 4px;
      height: 18px;
      background: linear-gradient(180deg, #00d9ff, #00ff88);
      border-radius: 2px;
    }
    
    .current-emotion {
      grid-column: 1 / -1;
    }
    .emotion-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      flex-wrap: wrap;
    }
    .dominant-emotion {
      text-align: center;
    }
    .dominant-emotion .emoji {
      font-size: 72px;
      margin-bottom: 8px;
    }
    .dominant-emotion .label {
      font-size: 24px;
      font-weight: 600;
      text-transform: capitalize;
    }
    
    .emotion-bars {
      flex: 1;
      max-width: 600px;
    }
    .emotion-bar {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .emotion-bar .name {
      width: 80px;
      font-size: 14px;
      text-transform: capitalize;
    }
    .emotion-bar .bar-container {
      flex: 1;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      overflow: hidden;
      margin: 0 12px;
    }
    .emotion-bar .bar {
      height: 100%;
      border-radius: 12px;
      transition: width 0.3s ease;
    }
    .emotion-bar .value {
      width: 50px;
      text-align: right;
      font-size: 14px;
      font-weight: 600;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }
    .stat-item {
      background: rgba(255,255,255,0.05);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-item .value {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, #00d9ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .stat-item .label {
      font-size: 12px;
      color: #8892b0;
      margin-top: 4px;
      text-transform: capitalize;
    }
    
    /* ê°ì •ë³„ ìƒ‰ìƒ */
    .bar-happy { background: linear-gradient(90deg, #ffd93d, #ffb347); }
    .bar-sad { background: linear-gradient(90deg, #74b9ff, #0984e3); }
    .bar-angry { background: linear-gradient(90deg, #ff4757, #c0392b); }
    .bar-surprise { background: linear-gradient(90deg, #a29bfe, #6c5ce7); }
    .bar-fear { background: linear-gradient(90deg, #2d3436, #636e72); }
    .bar-disgust { background: linear-gradient(90deg, #00b894, #00a86b); }
    .bar-neutral { background: linear-gradient(90deg, #b2bec3, #95a5a6); }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¯ AI ë©´ì ‘ ê°ì • ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
    <p>ì‹¤ì‹œê°„ ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤</p>
  </div>
  
  <div class="controls">
    <input type="text" id="sessionInput" placeholder="ì„¸ì…˜ ID ì…ë ¥..." />
    <select id="refreshRate">
      <option value="500">0.5ì´ˆ</option>
      <option value="1000" selected>1ì´ˆ</option>
      <option value="2000">2ì´ˆ</option>
      <option value="5000">5ì´ˆ</option>
    </select>
    <button id="startBtn" onclick="startMonitoring()">ğŸ“Š ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
    <button id="stopBtn" class="stop" onclick="stopMonitoring()">â¹ ì¤‘ì§€</button>
    <button onclick="loadAllSessions()">ğŸ”„ ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
  </div>
  
  <div class="status disconnected" id="statusBox">
    ìƒíƒœ: ëŒ€ê¸° ì¤‘ - ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ì„¸ìš”
  </div>
  
  <div class="dashboard-grid">
    <!-- í˜„ì¬ ê°ì • ìƒíƒœ -->
    <div class="card current-emotion">
      <div class="card-title">í˜„ì¬ ê°ì • ìƒíƒœ</div>
      <div class="emotion-display">
        <div class="dominant-emotion">
          <div class="emoji" id="dominantEmoji">ğŸ˜</div>
          <div class="label" id="dominantLabel">ëŒ€ê¸° ì¤‘</div>
        </div>
        <div class="emotion-bars" id="emotionBars">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
    </div>
    
    <!-- ì‹œê³„ì—´ ê·¸ë˜í”„ - ëª¨ë“  ê°ì • -->
    <div class="card full-width">
      <div class="card-title">ğŸ“ˆ ê°ì • ë³€í™” ì¶”ì´ (ì‹œê³„ì—´)</div>
      <div class="chart-container">
        <canvas id="timeSeriesChart"></canvas>
      </div>
    </div>
    
    <!-- ë„ë„› ì°¨íŠ¸ - ê°ì • ë¶„í¬ -->
    <div class="card">
      <div class="card-title">ğŸ¥§ í˜„ì¬ ê°ì • ë¶„í¬</div>
      <div class="chart-container">
        <canvas id="doughnutChart"></canvas>
      </div>
    </div>
    
    <!-- ë ˆì´ë” ì°¨íŠ¸ -->
    <div class="card">
      <div class="card-title">ğŸ¯ ê°ì • ë ˆì´ë”</div>
      <div class="chart-container">
        <canvas id="radarChart"></canvas>
      </div>
    </div>
    
    <!-- í†µê³„ ìš”ì•½ -->
    <div class="card full-width">
      <div class="card-title">ğŸ“Š ì„¸ì…˜ í†µê³„ ìš”ì•½</div>
      <div class="stats-grid" id="statsGrid">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
    </div>
  </div>

  <script>
    // ê°ì •ë³„ ìƒ‰ìƒ ë° ì´ëª¨ì§€ ë§¤í•‘
    const EMOTIONS = ['happy', 'sad', 'angry', 'surprise', 'fear', 'disgust', 'neutral'];
    const EMOTION_COLORS = {
      happy: 'rgba(255, 217, 61, 0.8)',
      sad: 'rgba(116, 185, 255, 0.8)',
      angry: 'rgba(255, 71, 87, 0.8)',
      surprise: 'rgba(162, 155, 254, 0.8)',
      fear: 'rgba(99, 110, 114, 0.8)',
      disgust: 'rgba(0, 184, 148, 0.8)',
      neutral: 'rgba(178, 190, 195, 0.8)'
    };
    const EMOTION_EMOJIS = {
      happy: 'ğŸ˜Š',
      sad: 'ğŸ˜¢',
      angry: 'ğŸ˜ ',
      surprise: 'ğŸ˜²',
      fear: 'ğŸ˜¨',
      disgust: 'ğŸ¤¢',
      neutral: 'ğŸ˜'
    };
    const EMOTION_LABELS_KO = {
      happy: 'í–‰ë³µ',
      sad: 'ìŠ¬í””',
      angry: 'ë¶„ë…¸',
      surprise: 'ë†€ëŒ',
      fear: 'ê³µí¬',
      disgust: 'í˜ì˜¤',
      neutral: 'ì¤‘ë¦½'
    };

    let monitoringInterval = null;
    let sessionId = null;
    let timeSeriesChart = null;
    let doughnutChart = null;
    let radarChart = null;
    
    // ì‹œê³„ì—´ ë°ì´í„° ì €ì¥ (ìµœê·¼ 60ê°œ í¬ì¸íŠ¸)
    const MAX_POINTS = 60;
    let timeSeriesData = {};
    EMOTIONS.forEach(e => timeSeriesData[e] = []);
    let timeLabels = [];

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    function initCharts() {
      // ì‹œê³„ì—´ ì°¨íŠ¸
      const tsCtx = document.getElementById('timeSeriesChart').getContext('2d');
      timeSeriesChart = new Chart(tsCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: EMOTIONS.map(e => ({
            label: EMOTION_LABELS_KO[e],
            data: [],
            borderColor: EMOTION_COLORS[e],
            backgroundColor: EMOTION_COLORS[e].replace('0.8', '0.1'),
            borderWidth: 2,
            tension: 0.3,
            fill: false,
            pointRadius: 0
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#fff', font: { size: 11 } }
            }
          },
          scales: {
            x: {
              ticks: { color: '#8892b0', maxTicksLimit: 10 },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
              min: 0,
              max: 100,
              ticks: { color: '#8892b0', callback: v => v + '%' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });

      // ë„ë„› ì°¨íŠ¸
      const dCtx = document.getElementById('doughnutChart').getContext('2d');
      doughnutChart = new Chart(dCtx, {
        type: 'doughnut',
        data: {
          labels: EMOTIONS.map(e => EMOTION_LABELS_KO[e]),
          datasets: [{
            data: new Array(7).fill(0),
            backgroundColor: EMOTIONS.map(e => EMOTION_COLORS[e]),
            borderColor: '#1e2a47',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#fff', font: { size: 11 }, padding: 10 }
            }
          },
          cutout: '60%'
        }
      });

      // ë ˆì´ë” ì°¨íŠ¸
      const rCtx = document.getElementById('radarChart').getContext('2d');
      radarChart = new Chart(rCtx, {
        type: 'radar',
        data: {
          labels: EMOTIONS.map(e => EMOTION_LABELS_KO[e]),
          datasets: [{
            label: 'ê°ì • ê°•ë„',
            data: new Array(7).fill(0),
            backgroundColor: 'rgba(0, 217, 255, 0.2)',
            borderColor: 'rgba(0, 217, 255, 0.8)',
            borderWidth: 2,
            pointBackgroundColor: EMOTIONS.map(e => EMOTION_COLORS[e]),
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { display: false },
              grid: { color: 'rgba(255,255,255,0.1)' },
              angleLines: { color: 'rgba(255,255,255,0.1)' },
              pointLabels: { color: '#fff', font: { size: 11 } }
            }
          }
        }
      });
    }

    // ê°ì • ë°” ìƒì„±
    function createEmotionBars() {
      const container = document.getElementById('emotionBars');
      container.innerHTML = EMOTIONS.map(e => `
        <div class="emotion-bar">
          <span class="name">${EMOTION_LABELS_KO[e]}</span>
          <div class="bar-container">
            <div class="bar bar-${e}" id="bar-${e}" style="width: 0%"></div>
          </div>
          <span class="value" id="value-${e}">0%</span>
        </div>
      `).join('');
    }

    // í†µê³„ ê·¸ë¦¬ë“œ ìƒì„±
    function createStatsGrid() {
      const container = document.getElementById('statsGrid');
      container.innerHTML = EMOTIONS.map(e => `
        <div class="stat-item">
          <div class="value" id="stat-${e}">0%</div>
          <div class="label">${EMOTION_EMOJIS[e]} ${EMOTION_LABELS_KO[e]} í‰ê· </div>
        </div>
      `).join('') + `
        <div class="stat-item">
          <div class="value" id="stat-total">0</div>
          <div class="label">ğŸ“Š ë°ì´í„° í¬ì¸íŠ¸</div>
        </div>
      `;
    }

    // ë°ì´í„° ì—…ë°ì´íŠ¸
    async function fetchAndUpdateData() {
      if (!sessionId) return;

      try {
        // í˜„ì¬ ê°ì • ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
        const emotionRes = await fetch('/emotion');
        const emotionData = await emotionRes.json();

        if (emotionData.status === 'no_data') {
          updateStatus('ë°ì´í„° ëŒ€ê¸° ì¤‘...', false);
          return;
        }

        updateStatus(`ì„¸ì…˜ ${sessionId} ëª¨ë‹ˆí„°ë§ ì¤‘...`, true);
        
        const probs = emotionData.probabilities || {};
        const dominant = emotionData.dominant_emotion;

        // í˜„ì¬ ê°ì • í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById('dominantEmoji').textContent = EMOTION_EMOJIS[dominant] || 'ğŸ˜';
        document.getElementById('dominantLabel').textContent = EMOTION_LABELS_KO[dominant] || dominant;

        // ê°ì • ë°” ì—…ë°ì´íŠ¸
        EMOTIONS.forEach(e => {
          const pct = (probs[e] || 0) * 100;
          document.getElementById(`bar-${e}`).style.width = pct + '%';
          document.getElementById(`value-${e}`).textContent = pct.toFixed(1) + '%';
        });

        // ë„ë„› ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        doughnutChart.data.datasets[0].data = EMOTIONS.map(e => (probs[e] || 0) * 100);
        doughnutChart.update('none');

        // ë ˆì´ë” ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        radarChart.data.datasets[0].data = EMOTIONS.map(e => (probs[e] || 0) * 100);
        radarChart.update('none');

        // ì‹œê³„ì—´ ë°ì´í„°ì— ì¶”ê°€
        const now = new Date().toLocaleTimeString();
        timeLabels.push(now);
        if (timeLabels.length > MAX_POINTS) timeLabels.shift();

        EMOTIONS.forEach(e => {
          timeSeriesData[e].push((probs[e] || 0) * 100);
          if (timeSeriesData[e].length > MAX_POINTS) timeSeriesData[e].shift();
        });

        // ì‹œê³„ì—´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        timeSeriesChart.data.labels = [...timeLabels];
        EMOTIONS.forEach((e, i) => {
          timeSeriesChart.data.datasets[i].data = [...timeSeriesData[e]];
        });
        timeSeriesChart.update('none');

        // í†µê³„ ì—…ë°ì´íŠ¸
        updateStats();

      } catch (err) {
        console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
        updateStatus('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨', false);
      }
    }

    // í†µê³„ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
    function updateStats() {
      EMOTIONS.forEach(e => {
        const data = timeSeriesData[e];
        if (data.length > 0) {
          const avg = data.reduce((a, b) => a + b, 0) / data.length;
          document.getElementById(`stat-${e}`).textContent = avg.toFixed(1) + '%';
        }
      });
      document.getElementById('stat-total').textContent = timeLabels.length;
    }

    // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateStatus(msg, connected) {
      const box = document.getElementById('statusBox');
      box.textContent = 'ìƒíƒœ: ' + msg;
      box.className = 'status ' + (connected ? 'connected' : 'disconnected');
    }

    // Redis ì‹œê³„ì—´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (íŠ¹ì • ê°ì •)
    async function fetchTimeSeries(emotion) {
      try {
        const res = await fetch(`/emotion/timeseries?session_id=${sessionId}&emotion=${emotion}&limit=100`);
        const data = await res.json();
        return data.points || [];
      } catch (err) {
        console.error('ì‹œê³„ì—´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
        return [];
      }
    }

    // ëª¨ë“  ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
    async function loadAllSessions() {
      try {
        const res = await fetch('/emotion/sessions');
        const data = await res.json();
        if (data.sessions && data.sessions.length > 0) {
          const select = document.createElement('select');
          select.id = 'sessionSelect';
          select.innerHTML = '<option value="">ì„¸ì…˜ ì„ íƒ...</option>' +
            data.sessions.map(s => `<option value="${s}">${s}</option>`).join('');
          select.onchange = (e) => {
            document.getElementById('sessionInput').value = e.target.value;
          };
          
          // ê¸°ì¡´ ì„¸ì…˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ì´ ìˆìœ¼ë©´ êµì²´
          const existing = document.getElementById('sessionSelect');
          if (existing) existing.replaceWith(select);
          else {
            const input = document.getElementById('sessionInput');
            input.parentNode.insertBefore(select, input);
          }
        }
      } catch (err) {
        console.log('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ì„ ìˆ˜ ìˆìŒ)');
      }
    }

    // ëª¨ë‹ˆí„°ë§ ì‹œì‘
    function startMonitoring() {
      sessionId = document.getElementById('sessionInput').value.trim();
      if (!sessionId) {
        // ì„¸ì…˜ IDê°€ ì—†ìœ¼ë©´ í˜„ì¬ í™œì„± ì„¸ì…˜ ì‚¬ìš©
        alert('ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ video.htmlì—ì„œ ë©´ì ‘ì„ ì‹œì‘í•˜ì„¸ìš”.');
        return;
      }

      // ë°ì´í„° ì´ˆê¸°í™”
      EMOTIONS.forEach(e => timeSeriesData[e] = []);
      timeLabels = [];

      const rate = parseInt(document.getElementById('refreshRate').value);
      if (monitoringInterval) clearInterval(monitoringInterval);
      
      fetchAndUpdateData();
      monitoringInterval = setInterval(fetchAndUpdateData, rate);
      updateStatus(`ì„¸ì…˜ ${sessionId} ì—°ê²° ì¤‘...`, false);
    }

    // ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
    function stopMonitoring() {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
      }
      updateStatus('ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨', false);
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      createEmotionBars();
      createStatsGrid();
      
      // URLì—ì„œ ì„¸ì…˜ ID ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const urlSessionId = urlParams.get('session_id');
      if (urlSessionId) {
        document.getElementById('sessionInput').value = urlSessionId;
      }
      
      // ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹œë„
      loadAllSessions();
    });
  </script>
</body>
</html>
